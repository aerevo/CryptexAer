name: Francois Build (Final Fortress)
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-secure-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Ambil Kod Kapten
        uses: actions/checkout@v3

      - name: 2. Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 3. Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: 4. PEMBINAAN TOTAL DI LUAR KAWASAN (The Master Template)
        run: |
          echo "Langkah 4.1: Bina projek baru di folder asing..."
          cd ..
          # Kita bina di luar terus, bukan dalam folder projek Kapten
          flutter create --platforms android --org com.cryptex --project-name cryptex_aer clean_project
          
          echo "Langkah 4.2: Pindahkan Nadi Kod Kapten ke Clean Project..."
          # Ambil fail lib dan pubspec Kapten sahaja
          rm -rf clean_project/lib
          cp -r $GITHUB_WORKSPACE/lib clean_project/
          cp $GITHUB_WORKSPACE/pubspec.yaml clean_project/
          
          # Salin assets jika wujud
          if [ -d "$GITHUB_WORKSPACE/assets" ]; then
            cp -r $GITHUB_WORKSPACE/assets clean_project/
          fi

          echo "Langkah 4.3: Suntikan Native Bridge (MainActivity.kt)..."
          mkdir -p clean_project/android/app/src/main/kotlin/com/cryptex/cryptex_aer
          cat > clean_project/android/app/src/main/kotlin/com/cryptex/cryptex_aer/MainActivity.kt <<EOF
          package com.cryptex.cryptex_aer
          import android.view.WindowManager
          import android.os.Bundle
          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import io.flutter.plugin.common.MethodChannel
          import java.io.File
          import android.content.pm.PackageManager

          class MainActivity: FlutterActivity() {
              private val CHANNEL = "com.cryptex/security"
              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL).setMethodCallHandler { call, result ->
                      when (call.method) {
                          "enableScreenshotProtection" -> {
                              window.addFlags(WindowManager.LayoutParams.FLAG_SECURE)
                              result.success(true)
                          }
                          "checkScreenshot" -> { result.success(false) }
                          "detectRootBypass" -> {
                              val packages = call.argument<List<String>>("packages")
                              val paths = call.argument<List<String>>("paths")
                              result.success(checkRootBypass(packages, paths))
                          }
                          else -> { result.notImplemented() }
                      }
                  }
              }
              private fun checkRootBypass(packages: List<String>?, paths: List<String>?): Boolean {
                  paths?.forEach { if (File(it).exists()) return true }
                  packages?.forEach { if (isPackageInstalled(it, packageManager)) return true }
                  return false
              }
              private fun isPackageInstalled(pName: String, pm: PackageManager): Boolean {
                  return try { pm.getPackageInfo(pName, 0); true } catch (e: Exception) { false }
              }
          }
          EOF

          echo "Langkah 4.4: Hard-Coding Permissions..."
          sed -i 's|<application|<uses-permission android:name="android.permission.VIBRATE"/>\n    <application|g' clean_project/android/app/src/main/AndroidManifest.xml
          echo "tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach { kotlinOptions { jvmTarget = '17' } }" >> clean_project/android/app/build.gradle

      - name: 5. Download Dependencies (In Clean Project)
        run: |
          cd ../clean_project
          flutter pub get

      - name: 6. BEDAH LIBRARY JAILBREAK (Critical Fix)
        run: |
          # Cari build.gradle dalam library tersebut
          JB_GRADLE=$(find $HOME/.pub-cache/hosted/pub.dev/flutter_jailbreak_detection-*/android -name "build.gradle")
          if [ ! -z "$JB_GRADLE" ]; then
            sed -i 's/android {/android { namespace "flutter.jailbreak_detection"/g' $JB_GRADLE
            cat >> $JB_GRADLE <<EOF
            android {
                compileOptions {
                    sourceCompatibility JavaVersion.VERSION_17
                    targetCompatibility JavaVersion.VERSION_17
                }
                kotlinOptions { jvmTarget = '17' }
            }
          EOF
          fi

      - name: 7. Build APK Release (The Moment of Truth)
        run: |
          cd ../clean_project
          # Kita tambah --android-skip-build-dependency-validation untuk keselamatan extra
          flutter build apk --obfuscate --split-debug-info=./debug_info --release --android-skip-build-dependency-validation

      - name: 8. Simpan APK
        uses: actions/upload-artifact@v4
        with:
          name: Z-KINETIC-ULTRA-SUCCESS
          path: ../clean_project/build/app/outputs/flutter-apk/app-release.apk
