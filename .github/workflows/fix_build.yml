name: Secure APK Build (Captain Aer)
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ¦… Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: ğŸ§¹ Clean Existing Android Structure
        run: |
          echo "==> Removing any existing android folder..."
          rm -rf android/
          
      - name: ğŸ—ï¸ Initialize Proper Android Structure
        run: |
          echo "==> Creating fresh Android platform..."
          flutter create . --platforms android --org com.cryptex --project-name cryptex_aer
          
          if [ ! -d "android" ]; then
            echo "ERROR: Android folder not created!"
            exit 1
          fi
          
          echo "âœ… Android structure initialized successfully"

      - name: ğŸ” Inject Native Security Code
        run: |
          echo "==> Creating MainActivity.kt with security features..."
          
          MAIN_ACTIVITY_DIR="android/app/src/main/kotlin/com/cryptex/cryptex_aer"
          mkdir -p "$MAIN_ACTIVITY_DIR"
          
          cat > "$MAIN_ACTIVITY_DIR/MainActivity.kt" << 'EOF'
          package com.cryptex.cryptex_aer
          
          import android.os.Bundle
          import android.view.WindowManager
          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import io.flutter.plugin.common.MethodChannel
          import java.io.File
          import android.content.pm.PackageManager
          
          class MainActivity: FlutterActivity() {
              private val SECURITY_CHANNEL = "com.cryptex/security"
              
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  window.setFlags(
                      WindowManager.LayoutParams.FLAG_SECURE,
                      WindowManager.LayoutParams.FLAG_SECURE
                  )
              }
              
              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  
                  MethodChannel(flutterEngine.dartExecutor.binaryMessenger, SECURITY_CHANNEL)
                      .setMethodCallHandler { call, result ->
                          when (call.method) {
                              "enableScreenshotProtection" -> {
                                  try {
                                      window.addFlags(WindowManager.LayoutParams.FLAG_SECURE)
                                      result.success(true)
                                  } catch (e: Exception) {
                                      result.error("PROTECTION_ERROR", e.message, null)
                                  }
                              }
                              
                              "checkScreenshot" -> {
                                  result.success(false)
                              }
                              
                              "detectRootBypass" -> {
                                  try {
                                      val packages = call.argument<List<String>>("packages") ?: emptyList()
                                      val paths = call.argument<List<String>>("paths") ?: emptyList()
                                      val isRooted = checkRootBypass(packages, paths)
                                      result.success(isRooted)
                                  } catch (e: Exception) {
                                      result.error("ROOT_CHECK_ERROR", e.message, null)
                                  }
                              }
                              
                              else -> {
                                  result.notImplemented()
                              }
                          }
                      }
              }
              
              private fun checkRootBypass(packages: List<String>, paths: List<String>): Boolean {
                  paths.forEach { path ->
                      if (File(path).exists()) {
                          return true
                      }
                  }
                  
                  packages.forEach { packageName ->
                      if (isPackageInstalled(packageName, packageManager)) {
                          return true
                      }
                  }
                  
                  return false
              }
              
              private fun isPackageInstalled(packageName: String, pm: PackageManager): Boolean {
                  return try {
                      pm.getPackageInfo(packageName, 0)
                      true
                  } catch (e: PackageManager.NameNotFoundException) {
                      false
                  }
              }
          }
          EOF
          
          echo "âœ… MainActivity.kt injected successfully"

      - name: âš™ï¸ Configure Android Manifest
        run: |
          echo "==> Adding required permissions..."
          
          MANIFEST_FILE="android/app/src/main/AndroidManifest.xml"
          sed -i '/<application/i \    <uses-permission android:name="android.permission.VIBRATE"/>' "$MANIFEST_FILE"
          
          echo "âœ… Permissions configured"

      - name: ğŸ”§ Configure Gradle Settings
        run: |
          echo "==> Configuring app/build.gradle..."
          
          APP_GRADLE="android/app/build.gradle"
          
          cat >> "$APP_GRADLE" << 'EOF'
          
          tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
              kotlinOptions {
                  jvmTarget = '17'
              }
          }
          
          android {
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          EOF
          
          echo "âœ… Gradle configured for Java 17"

      - name: ğŸ“¦ Download Flutter Dependencies
        run: |
          echo "==> Running flutter pub get..."
          flutter pub get
          
          echo "==> Verifying dependencies..."
          flutter pub deps | grep -E "flutter_jailbreak_detection|flutter_secure_storage|sensors_plus"

      - name: ğŸ” Fix Jailbreak Detection Library
        run: |
          echo "==> Patching flutter_jailbreak_detection library..."
          
          JB_GRADLE=$(find ~/.pub-cache/hosted/pub.dev -path "*/flutter_jailbreak_detection-*/android/build.gradle" | head -n 1)
          
          if [ -n "$JB_GRADLE" ]; then
            echo "Found: $JB_GRADLE"
            
            if ! grep -q "namespace" "$JB_GRADLE"; then
              sed -i '/android {/a \    namespace "flutter.jailbreak_detection"' "$JB_GRADLE"
            fi
            
            cat >> "$JB_GRADLE" << 'EOF'
          
          android {
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          
          tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
              kotlinOptions {
                  jvmTarget = '17'
              }
          }
          EOF
            
            echo "âœ… Jailbreak detection library patched"
          else
            echo "âš ï¸ Jailbreak detection library not found"
          fi

      - name: ğŸ›¡ï¸ Protect Server Folder
        run: |
          echo "==> Ensuring server folder is preserved..."
          
          if [ -d "server" ]; then
            echo "âœ… Server folder exists and is protected"
            ls -la server/ | head -5
          else
            echo "âš ï¸ No server folder found in repository"
          fi

      - name: ğŸ—ï¸ Pre-Build Validation
        run: |
          echo "==> Running pre-build checks..."
          
          if [ ! -f "android/app/build.gradle" ]; then
            echo "ERROR: android/app/build.gradle missing!"
            exit 1
          fi
          
          if [ ! -f "android/app/src/main/kotlin/com/cryptex/cryptex_aer/MainActivity.kt" ]; then
            echo "ERROR: MainActivity.kt not found!"
            exit 1
          fi
          
          flutter doctor -v
          
          echo "âœ… All pre-build checks passed"

      - name: ğŸš€ Build Release APK
        run: |
          echo "==> Building release APK with code obfuscation..."
          
          flutter build apk --release --obfuscate --split-debug-info=./debug_symbols
          
          if [ ! -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "ERROR: APK build failed!"
            exit 1
          fi
          
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          echo "âœ… APK built successfully (Size: $APK_SIZE)"

      - name: ğŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cryptex-aer-secure-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
          
      - name: ğŸ“¤ Upload Debug Symbols
        uses: actions/upload-artifact@v4
        with:
          name: debug-symbols
          path: debug_symbols/
          retention-days: 90

      - name: ğŸ¯ Build Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“± CRYPTEX AER - Build Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… APK: build/app/outputs/flutter-apk/app-release.apk"
          echo "âœ… Size: $(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)"
          echo "âœ… Obfuscation: Enabled"
          echo "âœ… Security: Screenshot protection + Root detection"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
