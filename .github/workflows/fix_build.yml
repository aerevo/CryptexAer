name: Francois Build (Advanced Native Injection)
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-secure-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Ambil Kod Kapten
        uses: actions/checkout@v3

      - name: 2. Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 3. Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: 4. PENJANAAN & SUNTIKAN NATIVE
        run: |
          echo "Membersihkan & Menjana Android dengan Package com.cryptex..."
          rm -rf android
          # Paksa create dengan package name yang betul
          flutter create . --platforms android --org com --project-name cryptex
          
          echo "Mencipta Folder Package..."
          mkdir -p android/app/src/main/kotlin/com/cryptex
          
          echo "Menyuntik MainActivity.kt (Z-KINETIC Bridge)..."
          cat > android/app/src/main/kotlin/com/cryptex/MainActivity.kt <<EOF
          package com.cryptex
          import android.view.WindowManager
          import android.os.Bundle
          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import io.flutter.plugin.common.MethodChannel
          import java.io.File
          import android.content.Context
          import android.content.pm.PackageManager

          class MainActivity: FlutterActivity() {
              private val CHANNEL = "com.cryptex/security"
              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL).setMethodCallHandler { call, result ->
                      when (call.method) {
                          "enableScreenshotProtection" -> {
                              window.addFlags(WindowManager.LayoutParams.FLAG_SECURE)
                              result.success(true)
                          }
                          "checkScreenshot" -> { result.success(false) }
                          "detectRootBypass" -> {
                              val packages = call.argument<List<String>>("packages")
                              val paths = call.argument<List<String>>("paths")
                              result.success(checkRootBypass(packages, paths))
                          }
                          else -> { result.notImplemented() }
                      }
                  }
              }
              private fun checkRootBypass(packages: List<String>?, paths: List<String>?): Boolean {
                  paths?.forEach { if (File(it).exists()) return true }
                  packages?.forEach { if (isPackageInstalled(it, packageManager)) return true }
                  return false
              }
              private fun isPackageInstalled(pName: String, pm: PackageManager): Boolean {
                  return try { pm.getPackageInfo(pName, 0); true } catch (e: Exception) { false }
              }
          }
          EOF

          echo "Menyuntik Vibrate Permission..."
          sed -i 's|<application|<uses-permission android:name="android.permission.VIBRATE"/>\n    <application|g' android/app/src/main/AndroidManifest.xml

      - name: 5. Download Dependencies
        run: flutter pub get

      - name: 6. BEDAH LIBRARY JAILBREAK (Namespace Fix)
        run: |
          JB_GRADLE=$(find $HOME/.pub-cache/hosted/pub.dev/flutter_jailbreak_detection-*/android -name "build.gradle")
          if [ ! -z "$JB_GRADLE" ]; then
            sed -i 's/android {/android { namespace "flutter.jailbreak_detection"/g' $JB_GRADLE
          fi

      - name: 7. Build APK Release
        run: flutter build apk --obfuscate --split-debug-info=./debug_info --release

      - name: 8. Simpan APK
        uses: actions/upload-artifact@v4
        with:
          name: cryptex-aer-advanced-security
          path: build/app/outputs/flutter-apk/app-release.apk
