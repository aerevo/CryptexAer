name: Secure APK Build (Gradle Template Override)
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ¦… Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: ğŸ”¥ Nuclear Clean
        run: |
          echo "==> Removing ALL Flutter artifacts..."
          rm -rf android/ ios/ build/ .dart_tool/ .flutter-plugins* .packages .metadata pubspec.lock
          echo "âœ… Clean complete"

      - name: ğŸ’¾ Backup Essential Files
        run: |
          echo "==> Backing up lib, TEST, pubspec.yaml, server, assets..."
          mkdir -p /tmp/cryptex_backup
          cp -r lib /tmp/cryptex_backup/
          # ğŸ‘‡ INI YANG SAYA TERTINGGAL TADI (Wajib ada!)
          cp -r test /tmp/cryptex_backup/
          cp pubspec.yaml /tmp/cryptex_backup/
          [ -d "server" ] && cp -r server /tmp/cryptex_backup/
          [ -d "assets" ] && cp -r assets /tmp/cryptex_backup/
          echo "âœ… Backup complete"

      - name: ğŸ—ï¸ Create Fresh Project
        run: |
          echo "==> Creating fresh Flutter project..."
          cd ..
          flutter create --platforms android --org com.cryptex --project-name cryptex_aer fresh_build
          
          test -d fresh_build/android || { echo "ERROR: Fresh project failed!"; exit 1; }
          echo "âœ… Fresh project created"

      - name: ğŸ“¦ Restore User Code
        run: |
          echo "==> Restoring backed up files..."
          cd ../fresh_build
          rm -rf lib/
          # ğŸ‘‡ KITA MASUKKAN BALIK FOLDER TEST KE RUMAH BARU
          cp -r /tmp/cryptex_backup/lib .
          cp -r /tmp/cryptex_backup/test .
          cp /tmp/cryptex_backup/pubspec.yaml .
          [ -d "/tmp/cryptex_backup/server" ] && cp -r /tmp/cryptex_backup/server .
          [ -d "/tmp/cryptex_backup/assets" ] && cp -r /tmp/cryptex_backup/assets .
          echo "âœ… Code restored"

      - name: ğŸ”§ Override build.gradle
        run: |
          cd ../fresh_build
          echo "==> Creating modern build.gradle..."
          cat > android/app/build.gradle << 'BUILDGRADLE'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
          }
          
          android {
              namespace "com.cryptex.cryptex_aer"
              compileSdk flutter.compileSdkVersion
              ndkVersion flutter.ndkVersion
          
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          
              kotlinOptions {
                  jvmTarget = "17"
              }
          
              defaultConfig {
                  applicationId "com.cryptex.cryptex_aer"
                  minSdk flutter.minSdkVersion
                  targetSdk flutter.targetSdkVersion
                  versionCode flutter.versionCode
                  versionName flutter.versionName
              }
          
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                  }
              }
          }
          
          flutter {
              source "../.."
          }
          BUILDGRADLE
          echo "âœ… build.gradle created"

      - name: ğŸ”§ Fix settings.gradle
        run: |
          cd ../fresh_build
          echo "==> Configuring settings.gradle..."
          cat > android/settings.gradle << 'SETTINGSGRADLE'
          pluginManagement {
              def flutterSdkPath = {
                  def properties = new Properties()
                  file("local.properties").withInputStream { properties.load(it) }
                  def flutterSdkPath = properties.getProperty("flutter.sdk")
                  assert flutterSdkPath != null, "flutter.sdk not set in local.properties"
                  return flutterSdkPath
              }()
          
              includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")
          
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          
          plugins {
              id "dev.flutter.flutter-plugin-loader" version "1.0.0"
              id "com.android.application" version "8.6.0" apply false
              id "org.jetbrains.kotlin.android" version "2.1.0" apply false
          }
          
          include ":app"
          SETTINGSGRADLE
          echo "âœ… settings.gradle configured"

      - name: ğŸ”§ Configure gradle.properties
        run: |
          cd ../fresh_build
          echo "==> Setting gradle.properties..."
          cat > android/gradle.properties << 'GRADLEPROPS'
          org.gradle.jvmargs=-Xmx4G -XX:MaxMetaspaceSize=1G -XX:+HeapDumpOnOutOfMemoryError
          android.useAndroidX=true
          android.enableJetifier=true
          android.defaults.buildfeatures.buildconfig=true
          android.nonTransitiveRClass=false
          android.nonFinalResIds=false
          GRADLEPROPS
          echo "âœ… gradle.properties configured"

      - name: ğŸ” Inject MainActivity.kt
        run: |
          cd ../fresh_build
          echo "==> Creating MainActivity.kt..."
          MAIN_DIR="android/app/src/main/kotlin/com/cryptex/cryptex_aer"
          mkdir -p "$MAIN_DIR"
          cat > "$MAIN_DIR/MainActivity.kt" << 'MAINACTIVITY'
          package com.cryptex.cryptex_aer
          
          import android.os.Bundle
          import android.view.WindowManager
          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import io.flutter.plugin.common.MethodChannel
          import java.io.File
          import android.content.pm.PackageManager
          
          class MainActivity: FlutterActivity() {
              private val SECURITY_CHANNEL = "com.cryptex/security"
              
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  window.setFlags(
                      WindowManager.LayoutParams.FLAG_SECURE,
                      WindowManager.LayoutParams.FLAG_SECURE
                  )
              }
              
              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  
                  MethodChannel(flutterEngine.dartExecutor.binaryMessenger, SECURITY_CHANNEL)
                      .setMethodCallHandler { call, result ->
                          when (call.method) {
                              "enableScreenshotProtection" -> {
                                  try {
                                      window.addFlags(WindowManager.LayoutParams.FLAG_SECURE)
                                      result.success(true)
                                  } catch (e: Exception) {
                                      result.error("PROTECTION_ERROR", e.message, null)
                                  }
                              }
                              "checkScreenshot" -> result.success(false)
                              "detectRootBypass" -> {
                                  try {
                                      val packages = call.argument<List<String>>("packages") ?: emptyList()
                                      val paths = call.argument<List<String>>("paths") ?: emptyList()
                                      result.success(checkRootBypass(packages, paths))
                                  } catch (e: Exception) {
                                      result.error("ROOT_CHECK_ERROR", e.message, null)
                                  }
                              }
                              else -> result.notImplemented()
                          }
                      }
              }
              
              private fun checkRootBypass(packages: List<String>, paths: List<String>): Boolean {
                  paths.forEach { if (File(it).exists()) return true }
                  packages.forEach { if (isPackageInstalled(it, packageManager)) return true }
                  return false
              }
              
              private fun isPackageInstalled(pkg: String, pm: PackageManager): Boolean {
                  return try { pm.getPackageInfo(pkg, 0); true } catch (e: Exception) { false }
              }
          }
          MAINACTIVITY
          echo "âœ… MainActivity.kt created"

      - name: âš™ï¸ Configure AndroidManifest
        run: |
          cd ../fresh_build
          echo "==> Adding permissions..."
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          sed -i '/<application/i \    <uses-permission android:name="android.permission.VIBRATE"/>' "$MANIFEST"
          echo "âœ… Manifest configured"

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd ../fresh_build
          echo "==> Running flutter pub get..."
          flutter pub get
          echo "==> Verifying dependencies..."
          flutter pub deps --style=compact | grep -E "flutter_jailbreak|flutter_secure_storage|sensors_plus" || true

      - name: ğŸ” Patch Jailbreak Library
        run: |
          echo "==> Patching flutter_jailbreak_detection..."
          JB_DIR=$(find ~/.pub-cache/hosted/pub.dev -type d -name "flutter_jailbreak_detection-*" 2>/dev/null | head -n 1)
          
          if [ -n "$JB_DIR" ]; then
            echo "Found library at: $JB_DIR"
            
            # Patch build.gradle
            JB_GRADLE="$JB_DIR/android/build.gradle"
            if [ -f "$JB_GRADLE" ]; then
              echo "Patching build.gradle..."
              if ! grep -q "namespace" "$JB_GRADLE"; then
                sed -i '/android {/a \    namespace "flutter.jailbreak_detection"' "$JB_GRADLE"
              fi
              if ! grep -q "jvmTarget" "$JB_GRADLE"; then
                cat >> "$JB_GRADLE" << 'JBPATCH'
          
          android {
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
              kotlinOptions { jvmTarget = "17" }
          }
          JBPATCH
              fi
            fi
            
            # CRITICAL FIX: Remove package attribute from AndroidManifest.xml
            JB_MANIFEST="$JB_DIR/android/src/main/AndroidManifest.xml"
            if [ -f "$JB_MANIFEST" ]; then
              echo "Patching AndroidManifest.xml..."
              sed -i 's/package="[^"]*"//g' "$JB_MANIFEST"
              sed -i 's/<manifest[^>]*>/<manifest xmlns:android="http:\/\/schemas.android.com\/apk\/res\/android">/g' "$JB_MANIFEST"
              echo "âœ… Removed legacy package attribute"
            fi
            
            echo "âœ… Library fully patched"
          else
            echo "âš ï¸ Library not found"
          fi

      - name: ğŸ§ª Verify Gradle Files
        run: |
          cd ../fresh_build
          echo "==> Verifying Gradle configuration..."
          grep -q "namespace" android/app/build.gradle && echo "âœ“ Namespace found"
          grep -q "dev.flutter.flutter-gradle-plugin" android/app/build.gradle && echo "âœ“ Flutter plugin found"
          grep -q "dev.flutter.flutter-plugin-loader" android/settings.gradle && echo "âœ“ Plugin loader found"
          test -f android/app/src/main/kotlin/com/cryptex/cryptex_aer/MainActivity.kt && echo "âœ“ MainActivity exists"
          echo ""
          flutter doctor -v
          echo "âœ… Validation complete"

      - name: ğŸ§  Run AI Engine Tests
        run: |
          cd ../fresh_build
          echo "==> Running Z-Kinetic AI Tests..."
          if [ -d "test" ]; then
             flutter test test/ai_engine_test.dart
          else
             echo "âŒ CRITICAL: Test folder still missing in fresh_build!"
             ls -R
             exit 1
          fi
      
      - name: ğŸš€ Build Release APK
        run: |
          cd ../fresh_build
          echo "==> Building release APK..."
          flutter build apk --release --obfuscate --split-debug-info=./debug_symbols
          if [ ! -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âŒ Build failed!"
            find build/app/outputs -type f 2>/dev/null || echo "No outputs"
            exit 1
          fi
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          echo "âœ… BUILD SUCCESS - Size: $APK_SIZE"

      - name: ğŸ“¦ Copy APK to Workspace
        run: |
          echo "==> Copying APK to workspace for artifact upload..."
          mkdir -p ${{ github.workspace }}/release_output
          cp ../fresh_build/build/app/outputs/flutter-apk/app-release.apk ${{ github.workspace }}/release_output/
          if [ -d "../fresh_build/debug_symbols" ]; then
            cp -r ../fresh_build/debug_symbols ${{ github.workspace }}/release_output/
          fi
          echo "âœ… Files copied to workspace"

      - name: ğŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: cryptex-aer-release
          path: release_output/app-release.apk
          retention-days: 30

      - name: ğŸ“¤ Upload Debug Symbols
        uses: actions/upload-artifact@v4
        with:
          name: debug-symbols
          path: release_output/debug_symbols/
          retention-days: 90
        continue-on-error: true

      - name: ğŸ‰ Success Summary
        run: |
          cd ../fresh_build
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   âœ… CRYPTEX AER BUILD SUCCESSFUL âœ…   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ Package: com.cryptex.cryptex_aer       â•‘"
          APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
          printf "â•‘ Size: %-32s â•‘\n" "$APK_SIZE"
          echo "â•‘ Obfuscation: ENABLED                   â•‘"
          echo "â•‘ Security: Screenshot + Root Detection â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
