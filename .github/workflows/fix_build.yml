name: Francois Build (Protected Pure Migration)
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-secure-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Ambil Kod Kapten
        uses: actions/checkout@v3

      - name: 2. Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 3. Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: 4. PROSES PEMBERSIHAN PILIHAN (Server & Git Safe)
        run: |
          echo "Langkah 4.1: Menyelamatkan kod Dart..."
          mkdir -p ../temp_source
          cp -r lib ../temp_source/
          cp pubspec.yaml ../temp_source/
          [ -d assets ] && cp -r assets ../temp_source/ || echo "Tiada folder assets."

          echo "Langkah 4.2: Pembersihan Bersasaran (Targeted Wipe)..."
          # Kita PADAM folder android lama & fail sampah Flutter sahaja
          # Kita TIDAK sentuh folder 'server' atau '.gitignore'
          rm -rf android
          rm -rf ios
          rm -rf build
          rm -rf .dart_tool
          rm -rf .metadata
          rm -f .packages
          rm -f .flutter-plugins
          rm -f .flutter-plugins-dependencies
          rm -f pubspec.lock

          echo "Langkah 4.3: Menjana semula struktur Android..."
          # Gunakan nama projek yang konsisten dengan kod Claude
          flutter create . --platforms android --org com.cryptex --project-name cryptex_aer
          
          echo "Langkah 4.4: Memulihkan kod Dart Kapten..."
          rm -rf lib
          cp -r ../temp_source/lib .
          cp ../temp_source/pubspec.yaml .
          [ -d ../temp_source/assets ] && cp -r ../temp_source/assets . || echo "Tiada assets untuk dipulihkan."

          echo "Langkah 4.5: Suntikan Nadi Native (MainActivity.kt)..."
          mkdir -p android/app/src/main/kotlin/com/cryptex/cryptex_aer
          cat > android/app/src/main/kotlin/com/cryptex/cryptex_aer/MainActivity.kt <<EOF
          package com.cryptex.cryptex_aer
          import android.view.WindowManager
          import android.os.Bundle
          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import io.flutter.plugin.common.MethodChannel
          import java.io.File
          import android.content.pm.PackageManager

          class MainActivity: FlutterActivity() {
              private val CHANNEL = "com.cryptex/security"
              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL).setMethodCallHandler { call, result ->
                      when (call.method) {
                          "enableScreenshotProtection" -> {
                              window.addFlags(WindowManager.LayoutParams.FLAG_SECURE)
                              result.success(true)
                          }
                          "checkScreenshot" -> { result.success(false) }
                          "detectRootBypass" -> {
                              val packages = call.argument<List<String>>("packages")
                              val paths = call.argument<List<String>>("paths")
                              result.success(checkRootBypass(packages, paths))
                          }
                          else -> { result.notImplemented() }
                      }
                  }
              }
              private fun checkRootBypass(packages: List<String>?, paths: List<String>?): Boolean {
                  paths?.forEach { if (File(it).exists()) return true }
                  packages?.forEach { if (isPackageInstalled(it, packageManager)) return true }
                  return false
              }
              private fun isPackageInstalled(pName: String, pm: PackageManager): Boolean {
                  return try { pm.getPackageInfo(pName, 0); true } catch (e: Exception) { false }
              }
          }
          EOF

          echo "Langkah 4.6: Suntikan Konfigurasi Global..."
          sed -i 's|<application|<uses-permission android:name="android.permission.VIBRATE"/>\n    <application|g' android/app/src/main/AndroidManifest.xml
          echo "tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach { kotlinOptions { jvmTarget = '17' } }" >> android/app/build.gradle

      - name: 5. Ambil Library Baru
        run: flutter pub get

      - name: 6. BEDAH LIBRARY JAILBREAK (Deep Surgery)
        run: |
          JB_GRADLE=$(find $HOME/.pub-cache/hosted/pub.dev/flutter_jailbreak_detection-*/android -name "build.gradle")
          if [ ! -z "$JB_GRADLE" ]; then
            sed -i 's/android {/android { namespace "flutter.jailbreak_detection"/g' $JB_GRADLE
            cat >> $JB_GRADLE <<EOF
            android {
                compileOptions {
                    sourceCompatibility JavaVersion.VERSION_17
                    targetCompatibility JavaVersion.VERSION_17
                }
                kotlinOptions { jvmTarget = '17' }
            }
          EOF
          fi

      - name: 7. Build APK Gred Bank
        run: |
          flutter build apk --obfuscate --split-debug-info=./debug_info --release --android-skip-build-dependency-validation

      - name: 8. Simpan APK
        uses: actions/upload-artifact@v4
        with:
          name: Z-KINETIC-ULTRA-READY
          path: build/app/outputs/flutter-apk/app-release.apk
