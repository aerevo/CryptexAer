name: Secure APK Build (Nuclear Clean)
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ¦… Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: ğŸ”¥ Nuclear Clean - Remove ALL Flutter Artifacts
        run: |
          echo "==> Removing ALL Flutter/Android generated files..."
          rm -rf android/
          rm -rf ios/
          rm -rf build/
          rm -rf .dart_tool/
          rm -rf .flutter-plugins
          rm -rf .flutter-plugins-dependencies
          rm -rf .packages
          rm -rf .metadata
          rm -rf pubspec.lock
          
          echo "âœ… All generated files removed"

      - name: ğŸ’¾ Backup Critical Files
        run: |
          echo "==> Backing up lib, pubspec.yaml, and server..."
          mkdir -p /tmp/backup
          cp -r lib /tmp/backup/
          cp pubspec.yaml /tmp/backup/
          
          if [ -d "server" ]; then
            cp -r server /tmp/backup/
          fi
          
          if [ -d "assets" ]; then
            cp -r assets /tmp/backup/
          fi
          
          echo "âœ… Critical files backed up to /tmp/backup"

      - name: ğŸ—ï¸ Create Fresh Flutter Project
        run: |
          echo "==> Creating brand new Flutter project structure..."
          cd ..
          
          flutter create --platforms android --org com.cryptex --project-name cryptex_aer fresh_build
          
          if [ ! -d "fresh_build/android" ]; then
            echo "ERROR: Fresh project creation failed!"
            exit 1
          fi
          
          echo "âœ… Fresh Flutter project created"

      - name: ğŸ“¦ Restore Code & Configuration
        run: |
          echo "==> Restoring backed up files..."
          cd ../fresh_build
          
          rm -rf lib/
          cp -r /tmp/backup/lib .
          
          cp /tmp/backup/pubspec.yaml .
          
          if [ -d "/tmp/backup/server" ]; then
            cp -r /tmp/backup/server .
          fi
          
          if [ -d "/tmp/backup/assets" ]; then
            cp -r /tmp/backup/assets .
          fi
          
          echo "âœ… Code and configuration restored"

      - name: ğŸ” Inject MainActivity.kt
        run: |
          cd ../fresh_build
          echo "==> Creating MainActivity.kt..."
          
          MAIN_DIR="android/app/src/main/kotlin/com/cryptex/cryptex_aer"
          mkdir -p "$MAIN_DIR"
          
          cat > "$MAIN_DIR/MainActivity.kt" << 'MAINACTIVITY_EOF'
          package com.cryptex.cryptex_aer
          
          import android.os.Bundle
          import android.view.WindowManager
          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import io.flutter.plugin.common.MethodChannel
          import java.io.File
          import android.content.pm.PackageManager
          
          class MainActivity: FlutterActivity() {
              private val SECURITY_CHANNEL = "com.cryptex/security"
              
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  window.setFlags(
                      WindowManager.LayoutParams.FLAG_SECURE,
                      WindowManager.LayoutParams.FLAG_SECURE
                  )
              }
              
              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  
                  MethodChannel(flutterEngine.dartExecutor.binaryMessenger, SECURITY_CHANNEL)
                      .setMethodCallHandler { call, result ->
                          when (call.method) {
                              "enableScreenshotProtection" -> {
                                  try {
                                      window.addFlags(WindowManager.LayoutParams.FLAG_SECURE)
                                      result.success(true)
                                  } catch (e: Exception) {
                                      result.error("PROTECTION_ERROR", e.message, null)
                                  }
                              }
                              "checkScreenshot" -> {
                                  result.success(false)
                              }
                              "detectRootBypass" -> {
                                  try {
                                      val packages = call.argument<List<String>>("packages") ?: emptyList()
                                      val paths = call.argument<List<String>>("paths") ?: emptyList()
                                      result.success(checkRootBypass(packages, paths))
                                  } catch (e: Exception) {
                                      result.error("ROOT_CHECK_ERROR", e.message, null)
                                  }
                              }
                              else -> result.notImplemented()
                          }
                      }
              }
              
              private fun checkRootBypass(packages: List<String>, paths: List<String>): Boolean {
                  paths.forEach { if (File(it).exists()) return true }
                  packages.forEach { if (isPackageInstalled(it, packageManager)) return true }
                  return false
              }
              
              private fun isPackageInstalled(pkg: String, pm: PackageManager): Boolean {
                  return try { pm.getPackageInfo(pkg, 0); true } catch (e: Exception) { false }
              }
          }
          MAINACTIVITY_EOF
          
          echo "âœ… MainActivity.kt created"

      - name: âš™ï¸ Configure Android Manifest
        run: |
          cd ../fresh_build
          echo "==> Adding permissions..."
          
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          sed -i '/<application/i \    <uses-permission android:name="android.permission.VIBRATE"/>' "$MANIFEST"
          
          echo "âœ… Manifest configured"

      - name: ğŸ”§ Configure Gradle for Java 17
        run: |
          cd ../fresh_build
          echo "==> Updating Gradle configuration..."
          
          cat >> android/app/build.gradle << 'GRADLE_EOF'
          
          tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
              kotlinOptions { jvmTarget = '17' }
          }
          
          android {
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          GRADLE_EOF
          
          echo "âœ… Gradle configured"

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd ../fresh_build
          echo "==> Running flutter pub get..."
          flutter pub get
          
          echo "==> Listing key dependencies..."
          flutter pub deps --style=compact | grep -E "cryptex_aer|flutter_jailbreak|flutter_secure_storage"

      - name: ğŸ” Patch Jailbreak Detection Library
        run: |
          echo "==> Finding and patching jailbreak detection..."
          
          JB_GRADLE=$(find ~/.pub-cache/hosted/pub.dev -path "*/flutter_jailbreak_detection-*/android/build.gradle" 2>/dev/null | head -n 1)
          
          if [ -n "$JB_GRADLE" ]; then
            echo "Found library at: $JB_GRADLE"
            
            if ! grep -q "namespace" "$JB_GRADLE"; then
              sed -i '/android {/a \    namespace "flutter.jailbreak_detection"' "$JB_GRADLE"
              echo "Added namespace"
            fi
            
            if ! grep -q "jvmTarget" "$JB_GRADLE"; then
              cat >> "$JB_GRADLE" << 'PATCH_EOF'
          
          android {
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          }
          
          tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
              kotlinOptions { jvmTarget = '17' }
          }
          PATCH_EOF
              echo "Added Java 17 compatibility"
            fi
            
            echo "âœ… Library patched successfully"
          else
            echo "âš ï¸ Library not found or already cached"
          fi

      - name: ğŸ§ª Pre-Build Validation
        run: |
          cd ../fresh_build
          echo "==> Validating project structure..."
          
          echo "Checking critical files..."
          test -f android/app/build.gradle && echo "âœ“ build.gradle exists"
          test -f android/app/src/main/kotlin/com/cryptex/cryptex_aer/MainActivity.kt && echo "âœ“ MainActivity.kt exists"
          test -f pubspec.yaml && echo "âœ“ pubspec.yaml exists"
          test -d lib && echo "âœ“ lib/ directory exists"
          
          echo ""
          echo "Running Flutter doctor..."
          flutter doctor -v
          
          echo ""
          echo "Analyzing project..."
          flutter analyze --no-fatal-infos || echo "âš ï¸ Analysis warnings (non-fatal)"
          
          echo "âœ… Pre-build validation complete"

      - name: ğŸš€ Build Release APK
        run: |
          cd ../fresh_build
          echo "==> Building release APK with obfuscation..."
          
          flutter build apk \
            --release \
            --obfuscate \
            --split-debug-info=./debug_symbols \
            --verbose
          
          if [ ! -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âŒ ERROR: APK was not generated!"
            echo "Checking build output directory..."
            find build/app/outputs -type f
            exit 1
          fi
          
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          
          echo ""
          echo "âœ… BUILD SUCCESS!"
          echo "ğŸ“¦ APK Size: $APK_SIZE"
          echo "ğŸ“ Location: $APK_PATH"

      - name: ğŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: cryptex-aer-release
          path: ../fresh_build/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: ğŸ“¤ Upload Debug Symbols
        uses: actions/upload-artifact@v4
        with:
          name: debug-symbols
          path: ../fresh_build/debug_symbols/
          retention-days: 90
        continue-on-error: true

      - name: ğŸ‰ Build Summary
        run: |
          cd ../fresh_build
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     ğŸš€ CRYPTEX AER - BUILD SUCCESSFUL ğŸš€      â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘ Package: com.cryptex.cryptex_aer              â•‘"
          echo "â•‘ APK Size: $(du -h "$APK_PATH" | cut -f1 | awk '{printf "%-37s", $1}') â•‘"
          echo "â•‘ Obfuscation: âœ… ENABLED                        â•‘"
          echo "â•‘ Security Features:                            â•‘"
          echo "â•‘   â€¢ Screenshot Protection (FLAG_SECURE)       â•‘"
          echo "â•‘   â€¢ Root/Jailbreak Detection                  â•‘"
          echo "â•‘   â€¢ Code Obfuscation + Symbol Stripping       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¥ Download your APK from the 'Artifacts' section above"
