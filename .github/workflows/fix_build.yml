name: Francois Build (Pure Migration)
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-secure-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Ambil Kod Kapten
        uses: actions/checkout@v3

      - name: 2. Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 3. Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: 4. PROSES PEMBERSIHAN TOTAL & MIGRASI
        run: |
          echo "Menyimpan kod Dart dan aset Kapten..."
          mkdir -p ../temp_source
          cp -r lib ../temp_source/
          cp -r assets ../temp_source/ 2>/dev/null || true
          cp pubspec.yaml ../temp_source/
          
          echo "Menghancurkan folder lama untuk pembersihan total..."
          # Padam semua fail termasuk fail halimunan .metadata dsb
          find . -maxdepth 1 -not -path '*/.*' -not -name '.' -delete
          rm -rf .metadata .packages .flutter-plugins .flutter-plugins-dependencies
          
          echo "Membina Projek Baru yang Suci..."
          flutter create . --platforms android --org com.cryptex --project-name cryptex_aer
          
          echo "Mengembalikan kod Dart dan aset Kapten ke dalam struktur baru..."
          rm -rf lib
          cp -r ../temp_source/lib .
          cp -r ../temp_source/assets . 2>/dev/null || true
          cp ../temp_source/pubspec.yaml .
          
          echo "Mencipta Folder Package Native..."
          mkdir -p android/app/src/main/kotlin/com/cryptex/cryptex_aer
          
          echo "Suntikan MainActivity.kt (Z-KINETIC Bridge)..."
          cat > android/app/src/main/kotlin/com/cryptex/cryptex_aer/MainActivity.kt <<EOF
          package com.cryptex.cryptex_aer
          import android.view.WindowManager
          import android.os.Bundle
          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import io.flutter.plugin.common.MethodChannel
          import java.io.File
          import android.content.pm.PackageManager

          class MainActivity: FlutterActivity() {
              private val CHANNEL = "com.cryptex/security"
              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  MethodChannel(flutterEngine.dartExecutor.binaryMessenger, CHANNEL).setMethodCallHandler { call, result ->
                      when (call.method) {
                          "enableScreenshotProtection" -> {
                              window.addFlags(WindowManager.LayoutParams.FLAG_SECURE)
                              result.success(true)
                          }
                          "checkScreenshot" -> { result.success(false) }
                          "detectRootBypass" -> {
                              val packages = call.argument<List<String>>("packages")
                              val paths = call.argument<List<String>>("paths")
                              result.success(checkRootBypass(packages, paths))
                          }
                          else -> { result.notImplemented() }
                      }
                  }
              }
              private fun checkRootBypass(packages: List<String>?, paths: List<String>?): Boolean {
                  paths?.forEach { if (File(it).exists()) return true }
                  packages?.forEach { if (isPackageInstalled(it, packageManager)) return true }
                  return false
              }
              private fun isPackageInstalled(pName: String, pm: PackageManager): Boolean {
                  return try { pm.getPackageInfo(pName, 0); true } catch (e: Exception) { false }
              }
          }
          EOF

          echo "Suntikan Permission & JVM Target 17..."
          sed -i 's|<application|<uses-permission android:name="android.permission.VIBRATE"/>\n    <application|g' android/app/src/main/AndroidManifest.xml
          echo "tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach { kotlinOptions { jvmTarget = '17' } }" >> android/app/build.gradle

      - name: 5. Download Dependencies
        run: flutter pub get

      - name: 6. BEDAH LIBRARY JAILBREAK
        run: |
          JB_GRADLE=$(find $HOME/.pub-cache/hosted/pub.dev/flutter_jailbreak_detection-*/android -name "build.gradle")
          if [ ! -z "$JB_GRADLE" ]; then
            sed -i 's/android {/android { namespace "flutter.jailbreak_detection"/g' $JB_GRADLE
            cat >> $JB_GRADLE <<EOF
            android {
                compileOptions {
                    sourceCompatibility JavaVersion.VERSION_17
                    targetCompatibility JavaVersion.VERSION_17
                }
                kotlinOptions { jvmTarget = '17' }
            }
          EOF
          fi

      - name: 7. Build APK Release
        run: |
          flutter build apk --obfuscate --split-debug-info=./debug_info --release --android-skip-build-dependency-validation

      - name: 8. Simpan APK
        uses: actions/upload-artifact@v4
        with:
          name: Z-KINETIC-ULTRA-FINAL
          path: build/app/outputs/flutter-apk/app-release.apk
