name: Secure APK Build (Captain Aer - Francois Final)
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• 1. Checkout Repository
        uses: actions/checkout@v3

      - name: ‚òï 2. Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ü¶Ö 3. Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: üßπ 4. Membersihkan Struktur Lama
        run: |
          echo "==> Menghancurkan folder android lama..."
          rm -rf android/
          rm -f pubspec.lock
          
      - name: üèóÔ∏è 5. Membina Semula Struktur Android
        run: |
          echo "==> Menjana platform Android yang suci..."
          # Membina struktur native baru dalam folder yang sama
          flutter create . --platforms android --org com.cryptex --project-name cryptex_aer
          
          if [ ! -d "android" ]; then
            echo "ERROR: Kegagalan kritikal pembinaan folder android!"
            exit 1
          fi
          echo "‚úÖ Struktur Android berjaya dijana."

      - name: üîê 6. Suntikan Nadi Security (MainActivity.kt)
        run: |
          echo "==> Menyuntik kod perisai ke MainActivity.kt..."
          
          # Tentukan folder destinasi berdasarkan project name
          MAIN_ACTIVITY_DIR="android/app/src/main/kotlin/com/cryptex/cryptex_aer"
          mkdir -p "$MAIN_ACTIVITY_DIR"
          
          # PENTING: Menggunakan 'KOTLIN_EOF' (dengan quote) untuk mengelakkan ralat YAML $ interpretation
          cat > "$MAIN_ACTIVITY_DIR/MainActivity.kt" <<'KOTLIN_EOF'
package com.cryptex.cryptex_aer

import android.os.Bundle
import android.view.WindowManager
import io.flutter.embedding.android.FlutterActivity
import io.flutter.embedding.engine.FlutterEngine
import io.flutter.plugin.common.MethodChannel
import java.io.File
import android.content.pm.PackageManager

class MainActivity: FlutterActivity() {
    private val SECURITY_CHANNEL = "com.cryptex/security"
    
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        // Perisai automatik: FLAG_SECURE sekat rakaman skrin & screenshot
        window.setFlags(
            WindowManager.LayoutParams.FLAG_SECURE,
            WindowManager.LayoutParams.FLAG_SECURE
        )
    }
    
    override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
        super.configureFlutterEngine(flutterEngine)
        
        MethodChannel(flutterEngine.dartExecutor.binaryMessenger, SECURITY_CHANNEL)
            .setMethodCallHandler { call, result ->
                when (call.method) {
                    "enableScreenshotProtection" -> {
                        window.addFlags(WindowManager.LayoutParams.FLAG_SECURE)
                        result.success(true)
                    }
                    "checkScreenshot" -> {
                        result.success(false) 
                    }
                    "detectRootBypass" -> {
                        val packages = call.argument<List<String>>("packages") ?: emptyList()
                        val paths = call.argument<List<String>>("paths") ?: emptyList()
                        result.success(checkRootBypass(packages, paths))
                    }
                    else -> result.notImplemented()
                }
            }
    }
    
    private fun checkRootBypass(packages: List<String>, paths: List<String>): Boolean {
        paths.forEach { if (File(it).exists()) return true }
        packages.forEach { if (isPackageInstalled(it, packageManager)) return true }
        return false
    }
    
    private fun isPackageInstalled(packageName: String, pm: PackageManager): Boolean {
        return try {
            pm.getPackageInfo(packageName, 0)
            true
        } catch (e: PackageManager.NameNotFoundException) {
            false
        }
    }
}
KOTLIN_EOF
          echo "‚úÖ Nadi Security berjaya disuntik."

      - name: ‚öôÔ∏è 7. Konfigurasi Manifest & Permissions
        run: |
          MANIFEST_FILE="android/app/src/main/AndroidManifest.xml"
          # Tambah VIBRATE permission tepat sebelum tag <application>
          sed -i '/<application/i \    <uses-permission android:name="android.permission.VIBRATE"/>' "$MANIFEST_FILE"
          echo "‚úÖ Permissions dikonfigurasi."

      - name: üîß 8. Penyelarasan JVM & Gradle (Java 17)
        run: |
          APP_GRADLE="android/app/build.gradle"
          # PENTING: Menggunakan 'GRADLE_EOF' (dengan quote)
          cat >> "$APP_GRADLE" <<'GRADLE_EOF'

tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
    kotlinOptions {
        jvmTarget = '17'
    }
}

android {
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
}
GRADLE_EOF
          echo "‚úÖ Gradle diselaraskan ke Java 17."

      - name: üì¶ 9. Download Dependencies
        run: flutter pub get

      - name: üîç 10. Pembedahan Library (Jailbreak Detection Patch)
        run: |
          # Cari build.gradle library jailbreak yang bermasalah dengan Java 17
          JB_GRADLE=$(find ~/.pub-cache/hosted/pub.dev -path "*/flutter_jailbreak_detection-*/android/build.gradle" | head -n 1)
          if [ -n "$JB_GRADLE" ]; then
            # Paksa Namespace & Java Compatibility
            sed -i '/android {/a \    namespace "flutter.jailbreak_detection"' "$JB_GRADLE"
            cat >> "$JB_GRADLE" <<'GRADLE_FIX'
android {
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
}
tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
    kotlinOptions { jvmTarget = '17' }
}
GRADLE_FIX
            echo "‚úÖ Library patched."
          fi

      - name: üöÄ 11. Build Release APK (Z-KINETIC ULTRA)
        run: |
          # Obfuscate untuk menyulitkan kod supaya tidak mudah di-reverse engineering
          flutter build apk \
            --release \
            --obfuscate \
            --split-debug-info=./debug_symbols

      - name: üì§ 12. Simpan Hasil APK
        uses: actions/upload-artifact@v4
        with:
          name: Z-KINETIC-ULTRA-READY
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7
