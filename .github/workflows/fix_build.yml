name: Francois Build (Blackout + Smuggling Mode)
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-secure-apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Ambil Kod Kapten
        uses: actions/checkout@v3

      - name: 2. Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: 3. Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: 4. SUNTIKAN PERISAI (Vibrate & Blackout)
        run: |
          echo "Membersihkan & Menjana Android..."
          rm -rf android
          flutter create . --platforms android
          
          echo "Menyuntik Vibrate Permission..."
          sed -i 's|<application|<uses-permission android:name="android.permission.VIBRATE"/>\n    <application|g' android/app/src/main/AndroidManifest.xml

          echo "Menyuntik Anti-Screenshot (Blackout)..."
          FILE_PATH=$(find android/app/src/main/kotlin -name "MainActivity.kt")
          PACKAGE_LINE=$(head -n 1 $FILE_PATH)
          
          cat > $FILE_PATH <<EOF
          $PACKAGE_LINE
          
          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import android.view.WindowManager
          
          class MainActivity: FlutterActivity() {
              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  window.setFlags(
                      WindowManager.LayoutParams.FLAG_SECURE,
                      WindowManager.LayoutParams.FLAG_SECURE
                  )
              }
          }
          EOF

      - name: 5. Download Dependencies
        run: flutter pub get

      - name: 6. Build APK Release (Obfuscated)
        run: flutter build apk --obfuscate --split-debug-info=./debug_info --release

      - name: 7. PENYELUDUPAN APK (Bypass GitHub Storage)
        # Kita guna curl untuk upload ke file.io sebab GitHub Artifact penuh.
        # Link akan keluar dalam log hitam skrin Kapten.
        run: |
          echo "GitHub Storage Penuh. Mengaktifkan Protokol Penyeludupan..."
          echo "Uploading to File.io..."
          
          # Upload dan simpan response
          RESPONSE=$(curl -F "file=@build/app/outputs/flutter-apk/app-release.apk" https://file.io)
          
          echo "---------------------------------------------------"
          echo "APK SIAP! KLIK LINK DI BAWAH UNTUK DOWNLOAD:"
          echo $RESPONSE
          echo "---------------------------------------------------"
          echo "Nota: Link ini hanya sah untuk SEKALI download sahaja."
