# File: .github/workflows/z-kinetic-unified.yml
# ðŸ›¡ï¸ Z-KINETIC UNIFIED PIPELINE (INFRA & CLIENT)
# Status: PRODUCTION READY âœ…
# Auditor: Francois (Butler)

name: Z-KINETIC Unified Pipeline
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  # ------------------------------------------------------------
  # JOB 1: FIREBASE INFRASTRUCTURE DEPLOYMENT
  # ------------------------------------------------------------
  firebase-deploy:
    name: ðŸš€ Firebase Infra Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ðŸ“¦ Install Functions Dependencies
        run: |
          cd functions
          npm install

      - name: ðŸš€ Deploy to Firebase
        uses: w9jds/firebase-action@master
        with:
          # Diselaraskan dengan project ID z-kinetic
          args: deploy --only functions,firestore:rules,firestore:indexes --project z-kinetic
        env:
          # Menggunakan Kunci JSON yang Tuan simpan di GitHub Secrets
          GCP_SA_KEY: ${{ secrets.FIREBASE_TOKEN }}

  # ------------------------------------------------------------
  # JOB 2: SECURE APK BUILD (GRADLE OVERRIDE)
  # ------------------------------------------------------------
  build-apk:
    name: ðŸ›¡ï¸ Secure APK Build
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¦… Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: ðŸ”¥ Nuclear Clean
        run: |
          echo "==> Removing ALL Flutter artifacts..."
          rm -rf android/ ios/ build/ .dart_tool/ .flutter-plugins* .packages .metadata pubspec.lock
          echo "âœ… Clean complete"

      - name: ðŸ’¾ Backup Essential Files
        run: |
          echo "==> Backing up lib, test, pubspec.yaml, server, assets..."
          mkdir -p /tmp/cryptex_backup
          cp -r lib /tmp/cryptex_backup/
          [ -d "test" ] && cp -r test /tmp/cryptex_backup/ || mkdir -p /tmp/cryptex_backup/test
          cp pubspec.yaml /tmp/cryptex_backup/
          [ -d "server" ] && cp -r server /tmp/cryptex_backup/
          [ -d "assets" ] && cp -r assets /tmp/cryptex_backup/
          echo "âœ… Backup complete"

      - name: ðŸ—ï¸ Create Fresh Project
        run: |
          echo "==> Creating fresh Flutter project..."
          cd ..
          flutter create --platforms android --org com.cryptex --project-name cryptex_aer fresh_build
          test -d fresh_build/android || { echo "ERROR: Fresh project failed!"; exit 1; }
          echo "âœ… Fresh project created"

      - name: ðŸ“¦ Restore User Code
        run: |
          echo "==> Restoring backed up files..."
          cd ../fresh_build
          rm -rf lib/
          cp -r /tmp/cryptex_backup/lib .
          cp -r /tmp/cryptex_backup/test .
          cp /tmp/cryptex_backup/pubspec.yaml .
          [ -d "/tmp/cryptex_backup/server" ] && cp -r /tmp/cryptex_backup/server .
          [ -d "/tmp/cryptex_backup/assets" ] && cp -r /tmp/cryptex_backup/assets .
          echo "âœ… Code restored"

      - name: ðŸ”§ Override build.gradle
        run: |
          cd ../fresh_build
          echo "==> Creating modern build.gradle..."
          cat > android/app/build.gradle << 'BUILDGRADLE'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
          }
          
          android {
              namespace "com.cryptex.cryptex_aer"
              compileSdk flutter.compileSdkVersion
              ndkVersion flutter.ndkVersion
          
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
          
              kotlinOptions {
                  jvmTarget = "17"
              }
          
              defaultConfig {
                  applicationId "com.cryptex.cryptex_aer"
                  minSdk flutter.minSdkVersion
                  targetSdk flutter.targetSdkVersion
                  versionCode flutter.versionCode
                  versionName flutter.versionName
              }
          
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      shrinkResources true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
          }
          
          flutter {
              source "../.."
          }
          BUILDGRADLE
          echo "âœ… build.gradle created"

      - name: ðŸ”§ Fix settings.gradle
        run: |
          cd ../fresh_build
          echo "==> Configuring settings.gradle..."
          cat > android/settings.gradle << 'SETTINGSGRADLE'
          pluginManagement {
              def flutterSdkPath = {
                  def properties = new Properties()
                  file("local.properties").withInputStream { properties.load(it) }
                  def flutterSdkPath = properties.getProperty("flutter.sdk")
                  assert flutterSdkPath != null, "flutter.sdk not set in local.properties"
                  return flutterSdkPath
              }()
          
              includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")
          
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          
          plugins {
              id "dev.flutter.flutter-plugin-loader" version "1.0.0"
              id "com.android.application" version "8.6.0" apply false
              id "org.jetbrains.kotlin.android" version "2.1.0" apply false
          }
          
          include ":app"
          SETTINGSGRADLE
          echo "âœ… settings.gradle configured"

      - name: ðŸ”§ Configure gradle.properties
        run: |
          cd ../fresh_build
          cat > android/gradle.properties << 'GRADLEPROPS'
          org.gradle.jvmargs=-Xmx4G -XX:MaxMetaspaceSize=1G -XX:+HeapDumpOnOutOfMemoryError
          android.useAndroidX=true
          android.enableJetifier=true
          android.defaults.buildfeatures.buildconfig=true
          android.nonTransitiveRClass=false
          android.nonFinalResIds=false
          GRADLEPROPS
          echo "âœ… gradle.properties configured"

      - name: ðŸ” Inject MainActivity.kt (Security Layer)
        run: |
          cd ../fresh_build
          MAIN_DIR="android/app/src/main/kotlin/com/cryptex/cryptex_aer"
          mkdir -p "$MAIN_DIR"
          cat > "$MAIN_DIR/MainActivity.kt" << 'MAINACTIVITY'
          package com.cryptex.cryptex_aer
          
          import android.os.Bundle
          import android.view.WindowManager
          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import io.flutter.plugin.common.MethodChannel
          import java.io.File
          import android.content.pm.PackageManager
          
          class MainActivity: FlutterActivity() {
              private val SECURITY_CHANNEL = "com.cryptex/security"
              
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  window.setFlags(
                      WindowManager.LayoutParams.FLAG_SECURE,
                      WindowManager.LayoutParams.FLAG_SECURE
                  )
              }
              
              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)
                  MethodChannel(flutterEngine.dartExecutor.binaryMessenger, SECURITY_CHANNEL)
                      .setMethodCallHandler { call, result ->
                          when (call.method) {
                              "enableScreenshotProtection" -> {
                                  window.addFlags(WindowManager.LayoutParams.FLAG_SECURE)
                                  result.success(true)
                              }
                              "detectRootBypass" -> {
                                  val packages = call.argument<List<String>>("packages") ?: emptyList()
                                  val paths = call.argument<List<String>>("paths") ?: emptyList()
                                  result.success(checkRootBypass(packages, paths))
                              }
                              else -> result.notImplemented()
                          }
                      }
              }
              
              private fun checkRootBypass(packages: List<String>, paths: List<String>): Boolean {
                  paths.forEach { if (File(it).exists()) return true }
                  packages.forEach { if (isPackageInstalled(it, packageManager)) return true }
                  return false
              }
              
              private fun isPackageInstalled(pkg: String, pm: PackageManager): Boolean {
                  return try { pm.getPackageInfo(pkg, 0); true } catch (e: Exception) { false }
              }
          }
          MAINACTIVITY
          echo "âœ… MainActivity.kt created"

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd ../fresh_build
          flutter pub get

      - name: ðŸš€ Build Release APK
        run: |
          cd ../fresh_build
          flutter build apk --release --obfuscate --split-debug-info=./debug_symbols
          mkdir -p ${{ github.workspace }}/release_output
          cp build/app/outputs/flutter-apk/app-release.apk ${{ github.workspace }}/release_output/
          [ -d "debug_symbols" ] && cp -r debug_symbols ${{ github.workspace }}/release_output/

      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cryptex-aer-release
          path: release_output/app-release.apk
          retention-days: 30
