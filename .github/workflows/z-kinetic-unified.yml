# File: .github/workflows/z-kinetic-unified.yml
# ğŸ›¡ï¸ Z-KINETIC (VERBOSE + MEMORY FIX)
# Status: DENGAN DEBUG LOGGING PENUH âœ…

name: Z-KINETIC Firebase Pipeline
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    name: ğŸ›¡ï¸ Secure APK Build
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ğŸ¦… Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: ğŸ’¾ Backup Essential Files
        run: |
          mkdir -p /tmp/backup_temp
          if [ -d "lib" ]; then cp -r lib /tmp/backup_temp/; else echo "âŒ LIB MISSING"; exit 1; fi
          if [ -f "pubspec.yaml" ]; then cp pubspec.yaml /tmp/backup_temp/; else echo "âŒ PUBSPEC MISSING"; exit 1; fi
          [ -d "test" ] && cp -r test /tmp/backup_temp/ || echo "âš ï¸ Test skipped"
          [ -d "assets" ] && cp -r assets /tmp/backup_temp/ || echo "âš ï¸ Assets skipped"
          echo "âœ… Backup complete"

      - name: ğŸ”¥ Nuclear Clean
        run: |
          rm -rf android/ ios/ build/ .dart_tool/ pubspec.lock || true
          echo "âœ… Clean complete"

      - name: ğŸ—ï¸ Create Fresh Project
        run: |
          flutter create --platforms android --org com.aer --project-name zkinetic .
          echo "âœ… Fresh project created"

      - name: ğŸ“¦ Restore User Code
        run: |
          rm -rf lib/
          cp -r /tmp/backup_temp/lib .
          cp /tmp/backup_temp/pubspec.yaml .
          [ -d "/tmp/backup_temp/test" ] && rm -rf test/ && cp -r /tmp/backup_temp/test . || echo "âš ï¸ No test"
          [ -d "/tmp/backup_temp/assets" ] && cp -r /tmp/backup_temp/assets . || echo "âš ï¸ No assets"
          echo "âœ… User code restored"

      - name: ğŸ”¥ Inject Firebase Crashlytics
        run: |
          if ! grep -q "firebase_crashlytics:" pubspec.yaml; then
            sed -i '/firebase_core:/a\  firebase_crashlytics: ^3.4.9' pubspec.yaml
          fi

      - name: ğŸ”¥ Create Firebase Config Files
        run: |
          mkdir -p lib android/app
          
          cat > lib/firebase_options.dart << 'FIREBASEOPTS'
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;
          
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) throw UnsupportedError('Web not configured');
              switch (defaultTargetPlatform) {
                case TargetPlatform.android: return android;
                case TargetPlatform.iOS: return ios;
                default: throw UnsupportedError('Platform not supported');
              }
            }
            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'AIzaSyDej3jrmqkUYyCs8CYepwdbrlInSBNWt_w',
              appId: '1:55621733629:android:ef51c1276ef226b0408294',
              messagingSenderId: '55621733629',
              projectId: 'z-kinetic',
              storageBucket: 'z-kinetic.firebasestorage.app',
            );
            static const FirebaseOptions ios = FirebaseOptions(
              apiKey: 'IOS_KEY', appId: 'IOS_ID', messagingSenderId: '55621733629',
              projectId: 'z-kinetic', storageBucket: 'z-kinetic.firebasestorage.app',
              iosBundleId: 'com.aer.zkinetic'
            );
          }
          FIREBASEOPTS
          
          cat > android/app/google-services.json << 'GOOGLESERVICES'
          {
            "project_info": { "project_number": "55621733629", "project_id": "z-kinetic", "storage_bucket": "z-kinetic.firebasestorage.app" },
            "client": [{
              "client_info": { "mobilesdk_app_id": "1:55621733629:android:ef51c1276ef226b0408294", "android_client_info": { "package_name": "com.aer.zkinetic" } },
              "api_key": [{ "current_key": "AIzaSyDej3jrmqkUYyCs8CYepwdbrlInSBNWt_w" }]
            }],
            "configuration_version": "1"
          }
          GOOGLESERVICES

      - name: ğŸ”§ Override build.gradle (MEMORY OPTIMIZED)
        run: |
          cat > android/app/build.gradle << 'BUILDGRADLE'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
              id "com.google.gms.google-services"
          }
          
          android {
              namespace "com.aer.zkinetic"
              compileSdk 36
              ndkVersion flutter.ndkVersion
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
              
              defaultConfig {
                  applicationId "com.aer.zkinetic"
                  minSdk 23
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
                  multiDexEnabled true
              }
              
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      // ğŸ‘‡ DISABLE MINIFY DULU UNTUK DEBUG
                      minifyEnabled false
                      shrinkResources false
                  }
              }
          }
          
          flutter { source "../.." }
          
          dependencies {
              implementation platform('com.google.firebase:firebase-bom:32.7.0')
              implementation 'com.google.firebase:firebase-analytics'
              implementation 'com.google.firebase:firebase-crashlytics'
              implementation 'com.google.firebase:firebase-auth'
              implementation 'com.google.firebase:firebase-firestore'
              implementation 'androidx.multidex:multidex:2.0.1'
          }
          BUILDGRADLE

      - name: ğŸ”§ Fix Project build.gradle
        run: |
          cat > android/build.gradle << 'PROJECTGRADLE'
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.7.3'
                  classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:2.1.0'
                  classpath 'com.google.gms:google-services:4.4.0'
                  classpath 'com.google.firebase:firebase-crashlytics-gradle:2.9.9'
              }
          }
          allprojects { repositories { google(); mavenCentral() } }
          PROJECTGRADLE

      - name: ğŸ”§ Fix settings.gradle
        run: |
          cat > android/settings.gradle << 'SETTINGSGRADLE'
          pluginManagement {
              def flutterSdkPath = {
                  def properties = new Properties()
                  file("local.properties").withInputStream { properties.load(it) }
                  def flutterSdkPath = properties.getProperty("flutter.sdk")
                  assert flutterSdkPath != null, "flutter.sdk not set"
                  return flutterSdkPath
              }()
              includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")
              repositories { google(); mavenCentral(); gradlePluginPortal() }
          }
          plugins {
              id "dev.flutter.flutter-plugin-loader" version "1.0.0"
              id "com.android.application" version "8.7.3" apply false
              id "org.jetbrains.kotlin.android" version "2.1.0" apply false
              id "com.google.gms.google-services" version "4.4.0" apply false
          }
          include ":app"
          SETTINGSGRADLE

      - name: ğŸ”§ Configure gradle.properties (INCREASED MEMORY)
        run: |
          cat > android/gradle.properties << 'GRADLEPROPS'
          org.gradle.jvmargs=-Xmx6144M -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -XX:+UseParallelGC
          org.gradle.daemon=false
          org.gradle.parallel=true
          org.gradle.caching=true
          android.useAndroidX=true
          android.enableJetifier=true
          android.nonTransitiveRClass=false
          GRADLEPROPS

      - name: ğŸ“¦ Install Dependencies
        run: |
          flutter pub get
          echo "âœ… Dependencies installed"

      - name: ğŸ” Verify Build Configuration
        run: |
          echo "ğŸ“ Checking build.gradle..."
          cat android/app/build.gradle | grep -A 5 "buildTypes"
          echo "ğŸ“ Checking gradle.properties..."
          cat android/gradle.properties
          echo "ğŸ“ Checking google-services.json..."
          cat android/app/google-services.json | head -10

      - name: ğŸš€ Build Release APK (WITH VERBOSE LOGGING)
        run: |
          # Tambah --verbose untuk debug
          flutter build apk --release --verbose 2>&1 | tee build_log.txt || {
            echo "âŒ BUILD FAILED - Printing last 100 lines:"
            tail -100 build_log.txt
            exit 1
          }

      - name: ğŸ“¤ Upload Build Log (If Failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build_log.txt
          retention-days: 7

      - name: ğŸ” Verify APK Exists
        run: |
          echo "ğŸ” Looking for APK..."
          find build -name "*.apk" -type f || echo "âŒ NO APK FOUND"
          
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âœ… APK FOUND!"
            ls -lh build/app/outputs/flutter-apk/app-release.apk
          else
            echo "âŒ APK NOT IN EXPECTED LOCATION"
            echo "ğŸ“ Listing build directory:"
            ls -R build/ || true
            exit 1
          fi

      - name: ğŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cryptex-aer-release
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
