name: Z-Kinetic Final Release (Auto-Config)
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    name: ðŸ›¡ï¸ Build APK (com.aer.zkinetic)
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¦… Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ðŸ”¥ Nuclear Clean (Remove Old Android Folder)
        run: |
          echo "==> Destroying old Android folder and locks..."
          rm -rf android/ ios/ build/ .dart_tool/ pubspec.lock
          echo "âœ… Clean complete."

      - name: ðŸ—ï¸ Create Fresh Project (com.aer.zkinetic)
        run: |
          echo "==> Recreating project structure on-the-fly..."
          flutter create --platforms android --org com.aer --project-name zkinetic .

      - name: ðŸ©¹ Fix Dependency Versions
        run: |
          echo "==> Forcing screen_protector to stable version ^1.5.1..."
          sed -i 's/screen_protector: .*/screen_protector: ^1.5.1/' pubspec.yaml

      - name: ðŸ“¦ Install Dependencies
        run: flutter pub get

      - name: ðŸ› ï¸ NUCLEAR PATCH: Fix device_apps Namespace
        run: |
          echo "==> Patching broken device_apps plugin in pub-cache..."
          find /home/runner/.pub-cache -name "build.gradle" -path "*/device_apps*/android/build.gradle" -exec sed -i '/android {/a \    namespace "fr.g123k.deviceapps"' {} \;
          echo "âœ… Patch applied to cached library."

      - name: ðŸ” Inject google-services.json
        run: |
          echo "==> Injecting Firebase Security Configuration..."
          cat > android/app/google-services.json << 'EOF'
          {
            "project_info": {
              "project_number": "55621733629",
              "project_id": "z-kinetic",
              "storage_bucket": "z-kinetic.firebasestorage.app"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:55621733629:android:ef51c1276ef226b0408294",
                  "android_client_info": {
                    "package_name": "com.aer.zkinetic"
                  }
                },
                "api_key": [
                  {
                    "current_key": "AIzaSyDej3jrmqkUYyCs8CYepwdbrlInSBNWt_w"
                  }
                ],
                "services": {
                  "appinvite_service": { "status": 1 },
                  "ads_service": { "status": 1 }
                }
              }
            ],
            "configuration_version": "1"
          }
          EOF

      - name: ðŸ”§ Inject Project build.gradle
        run: |
          echo "==> Configuring Root build.gradle..."
          cat > android/build.gradle << 'EOF'
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.2.1'
                  classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.22"
                  classpath 'com.google.gms:google-services:4.4.0'
              }
          }
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.buildDir = '../build'
          subprojects {
              project.buildDir = "${rootProject.buildDir}/${project.name}"
          }
          subprojects {
              project.evaluationDependsOn(':app')
          }
          tasks.register("clean", Delete) {
              delete rootProject.buildDir
          }
          EOF

      - name: ðŸ”§ Inject App build.gradle
        run: |
          echo "==> Configuring App-level build.gradle..."
          cat > android/app/build.gradle << 'EOF'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
              id "com.google.gms.google-services"
          }
          android {
              namespace "com.aer.zkinetic"
              compileSdk 34
              defaultConfig {
                  applicationId "com.aer.zkinetic"
                  minSdk 23
                  targetSdk 34
                  versionCode 1
                  versionName "3.0.0"
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      shrinkResources false
                      minifyEnabled false
                  }
              }
          }
          EOF

      - name: ðŸ§ª Generate Firebase Options
        run: |
          echo "==> Injecting firebase_options.dart..."
          mkdir -p lib
          cat > lib/firebase_options.dart << 'EOF'
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;

          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) throw UnsupportedError('Web not configured');
              switch (defaultTargetPlatform) {
                case TargetPlatform.android:
                  return android;
                default:
                  throw UnsupportedError('Platform not supported');
              }
            }

            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'AIzaSyDej3jrmqkUYyCs8CYepwdbrlInSBNWt_w',
              appId: '1:55621733629:android:ef51c1276ef226b0408294',
              messagingSenderId: '55621733629',
              projectId: 'z-kinetic',
              storageBucket: 'z-kinetic.firebasestorage.app',
            );
          }
          EOF

      - name: ðŸš€ Build APK (Release Mode)
        run: flutter build apk --release --no-tree-shake-icons

      - name: ðŸ“¤ Upload Z-Kinetic Artifact
        uses: actions/upload-artifact@v4
        with:
          name: z-kinetic-v3-build
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 5
