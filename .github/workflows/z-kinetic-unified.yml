name: "Z-Kinetic Final Release (Auto-Fix HTTP)"
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    name: "ðŸ›¡ï¸ Build APK (com.aer.zkinetic)"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "â˜• Setup Java 17"
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: "ðŸ¦… Setup Flutter (Stable)"
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      # â˜¢ï¸ STEP BAHAYA (Tapi kita dah cover)
      - name: "ðŸ”¥ Nuclear Clean (Remove Old Android Folder)"
        run: |
          echo "==> Destroying old Android folder and locks..."
          rm -rf android/ ios/ build/ .dart_tool/ pubspec.lock
          echo "âœ… Clean complete."

      - name: "ðŸ—ï¸ Create Fresh Project (com.aer.zkinetic)"
        run: |
          echo "==> Recreating project structure on-the-fly..."
          flutter create --platforms android --org com.aer --project-name zkinetic .

      # ðŸ”¥ðŸ”¥ðŸ”¥ INI STEP BARU YANG SAYA TAMBAH ðŸ”¥ðŸ”¥ðŸ”¥
      # Dia akan paksa AndroidManifest terima HTTP (Localhost/IP)
      - name: "ðŸ”“ Inject Network Permissions (Fix Loading Issue)"
        run: |
          echo "==> Injecting INTERNET & CLEARTEXT permissions..."
          
          # 1. Masukkan Permission Internet
          sed -i 's|<application|<uses-permission android:name="android.permission.INTERNET"/>\n    <application|' android/app/src/main/AndroidManifest.xml
          
          # 2. Masukkan CleartextTraffic (Supaya boleh baca HTTP IP Address)
          sed -i 's|android:label=|android:usesCleartextTraffic="true"\n        android:label=|' android/app/src/main/AndroidManifest.xml
          
          echo "âœ… Permissions Injected Successfully!"

      - name: "ðŸ©¹ Fix Dependency Versions"
        run: |
          echo "==> Forcing screen_protector to stable version ^1.5.1..."
          sed -i 's/screen_protector: .*/screen_protector: ^1.5.1/' pubspec.yaml || true
          flutter pub get

      - name: "ðŸ”¥ Generate Firebase Options (Bypass Web Error)"
        run: |
          echo "==> Injecting dummy firebase_options.dart..."
          mkdir -p lib
          cat > lib/firebase_options.dart << 'EOF'
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;

          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) throw UnsupportedError('Web not configured');
              switch (defaultTargetPlatform) {
                case TargetPlatform.android:
                  return android;
                default:
                  throw UnsupportedError('Platform not supported');
              }
            }

            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'AIzaSyDej3jrmqkUYyCs8CYepwdbrlInSBNWt_w',
              appId: '1:55621733629:android:ef51c1276ef226b0408294',
              messagingSenderId: '55621733629',
              projectId: 'z-kinetic',
              storageBucket: 'z-kinetic.firebasestorage.app',
            );
          }
          EOF

      - name: "ðŸš€ Build APK (Release Mode)"
        run: flutter build apk --release --no-tree-shake-icons

      - name: "ðŸ“¤ Upload Z-Kinetic Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: z-kinetic-v3-build
          path: build/app/outputs/flutter-apk/app-release.apk
