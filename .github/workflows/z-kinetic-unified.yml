# File: .github/workflows/z-kinetic-unified.yml
# ðŸ›¡ï¸ Z-KINETIC GHOST PROTOCOL (UNBREAKABLE RESTORE)
# Status: ERROR HANDLED & SURGICAL PATCH READY âœ…
# Auditor: Francois (Butler)

name: Z-KINETIC Ghost Pipeline
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    name: ðŸ›¡ï¸ Secure APK Build
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¦… Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: ðŸ”¥ Nuclear Clean
        run: |
          rm -rf android/ ios/ build/ .dart_tool/ pubspec.lock || true
          echo "âœ… Clean complete"

      - name: ðŸ’¾ Backup Essential Files
        run: |
          echo "==> Starting Backup..."
          # Guna path relative yang lebih selamat
          mkdir -p ../backup_temp
          
          # Salin LIB (Wajib)
          if [ -d "lib" ]; then cp -r lib ../backup_temp/; else echo "âŒ LIB MISSING IN ROOT"; exit 1; fi
          
          # Salin PUBSPEC (Wajib)
          if [ -f "pubspec.yaml" ]; then cp pubspec.yaml ../backup_temp/; else echo "âŒ PUBSPEC MISSING IN ROOT"; exit 1; fi
          
          # Salin TEST (Jika ada)
          [ -d "test" ] && cp -r test ../backup_temp/ || echo "âš ï¸ Test folder skipped"
          
          # Salin ASSETS (Jika ada)
          [ -d "assets" ] && cp -r assets ../backup_temp/ || echo "âš ï¸ Assets folder skipped"
          
          echo "âœ… Backup secured in ../backup_temp"

      - name: ðŸ—ï¸ Create Fresh Project
        run: |
          cd ..
          flutter create --platforms android --org com.cryptex --project-name cryptex_aer fresh_build

      - name: ðŸ“¦ Restore User Code (Safely)
        run: |
          echo "==> Restoring Code..."
          cd ../fresh_build
          
          # 1. Restore Lib (Buang yang fresh, ganti dengan backup)
          rm -rf lib/
          cp -r ../backup_temp/lib . || { echo "âŒ Failed to restore LIB"; exit 1; }
          
          # 2. Restore Pubspec
          cp ../backup_temp/pubspec.yaml . || { echo "âŒ Failed to restore PUBSPEC"; exit 1; }
          
          # 3. Restore Test (Jika backup wujud)
          if [ -d "../backup_temp/test" ]; then
             rm -rf test/ # Buang test folder default
             cp -r ../backup_temp/test .
             echo "âœ… Test restored"
          else
             echo "âš ï¸ No test backup found, skipping."
          fi
          
          # 4. Restore Assets (Jika backup wujud)
          if [ -d "../backup_temp/assets" ]; then
             cp -r ../backup_temp/assets .
             echo "âœ… Assets restored"
          else
             echo "âš ï¸ No assets backup found, skipping."
          fi

      - name: ðŸ¥ Surgical Patch (Auto-Fix Vibration)
        run: |
          cd ../fresh_build
          echo "==> Patching Code..."
          # Tukar Import Vibration ke Services
          grep -rl "package:vibration/vibration.dart" lib/ | xargs sed -i 's|package:vibration/vibration.dart|package:flutter/services.dart|g' || true
          # Tukar Fungsi Vibrate ke HapticFeedback
          grep -rl "Vibration.vibrate" lib/ | xargs sed -i 's|Vibration.vibrate.*|HapticFeedback.heavyImpact();|g' || true
          # Tukar Check HasVibrator
          grep -rl "Vibration.hasVibrator" lib/ | xargs sed -i 's|Vibration.hasVibrator.*|Future.value(true)|g' || true
          echo "âœ… Code patched"

      - name: ðŸ”§ Override build.gradle
        run: |
          cd ../fresh_build
          cat > android/app/build.gradle << 'BUILDGRADLE'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
          }
          android {
              namespace "com.cryptex.cryptex_aer"
              compileSdk flutter.compileSdkVersion
              ndkVersion flutter.ndkVersion
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
              defaultConfig {
                  applicationId "com.cryptex.cryptex_aer"
                  minSdk flutter.minSdkVersion
                  targetSdk flutter.targetSdkVersion
                  versionCode flutter.versionCode
                  versionName flutter.versionName
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      shrinkResources true
                  }
              }
          }
          flutter { source "../.." }
          BUILDGRADLE

      - name: ðŸ”§ Fix settings.gradle
        run: |
          cd ../fresh_build
          cat > android/settings.gradle << 'SETTINGSGRADLE'
          pluginManagement {
              def flutterSdkPath = {
                  def properties = new Properties()
                  file("local.properties").withInputStream { properties.load(it) }
                  def flutterSdkPath = properties.getProperty("flutter.sdk")
                  assert flutterSdkPath != null, "flutter.sdk not set in local.properties"
                  return flutterSdkPath
              }()
              includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")
              repositories { google(); mavenCentral(); gradlePluginPortal() }
          }
          plugins {
              id "dev.flutter.flutter-plugin-loader" version "1.0.0"
              id "com.android.application" version "8.3.2" apply false
              id "org.jetbrains.kotlin.android" version "1.9.24" apply false
          }
          include ":app"
          SETTINGSGRADLE

      - name: ðŸ”§ Configure gradle.properties (RAM Optimized)
        run: |
          cd ../fresh_build
          cat > android/gradle.properties << 'GRADLEPROPS'
          org.gradle.jvmargs=-Xmx4096M -XX:+UseParallelGC
          org.gradle.daemon=false
          android.useAndroidX=true
          android.enableJetifier=true
          GRADLEPROPS

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd ../fresh_build
          flutter pub get

      - name: ðŸš€ Build Release APK
        run: |
          cd ../fresh_build
          flutter build apk --release --obfuscate --split-debug-info=./debug_symbols --android-skip-build-dependency-validation

      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cryptex-aer-release
          path: ../fresh_build/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
