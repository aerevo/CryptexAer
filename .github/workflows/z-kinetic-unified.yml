# File: .github/workflows/z-kinetic-unified.yml
# ðŸ›¡ï¸ Z-KINETIC GHOST PROTOCOL (BULLETPROOF VERSION)
# Status: REPAIRING BACKUP PATHS âœ…
# Auditor: Francois (Butler)

name: Z-KINETIC Ghost Pipeline
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    name: ðŸ›¡ï¸ Secure APK Build
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¦… Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: ðŸ” Debug Directory Structure
        run: |
          echo "Current Path: $(pwd)"
          echo "Files in root:"
          ls -F

      - name: ðŸ”¥ Nuclear Clean
        run: |
          echo "==> Cleaning old artifacts..."
          # Menggunakan || true supaya jika fail tiada, robot tidak ralat
          rm -rf android/ ios/ build/ .dart_tool/ pubspec.lock || true
          echo "âœ… Clean complete"

      - name: ðŸ’¾ Backup Essential Files (Robust Mode)
        run: |
          echo "==> Creating backup directory..."
          mkdir -p /home/runner/cryptex_backup
          
          echo "==> Copying files if they exist..."
          # Menyalin secara selamat: Jika folder wujud, baru salin.
          [ -d "lib" ] && cp -r lib /home/runner/cryptex_backup/ || echo "âš ï¸ Warning: lib not found"
          [ -d "test" ] && cp -r test /home/runner/cryptex_backup/ || mkdir -p /home/runner/cryptex_backup/test
          [ -f "pubspec.yaml" ] && cp pubspec.yaml /home/runner/cryptex_backup/ || echo "âš ï¸ Warning: pubspec.yaml not found"
          [ -d "assets" ] && cp -r assets /home/runner/cryptex_backup/ || echo "âš ï¸ Warning: assets not found"
          
          echo "âœ… Backup process finished"

      - name: ðŸ—ï¸ Create Fresh Project
        run: |
          cd ..
          flutter create --platforms android --org com.cryptex --project-name cryptex_aer fresh_build

      - name: ðŸ“¦ Restore User Code
        run: |
          echo "==> Restoring from backup..."
          cd ../fresh_build
          rm -rf lib/
          cp -r /home/runner/cryptex_backup/lib .
          cp -r /home/runner/cryptex_backup/test .
          cp /home/runner/cryptex_backup/pubspec.yaml .
          [ -d "/home/runner/cryptex_backup/assets" ] && cp -r /home/runner/cryptex_backup/assets .
          echo "âœ… Code restored to fresh_build"

      - name: ðŸ”§ Override build.gradle
        run: |
          cd ../fresh_build
          cat > android/app/build.gradle << 'BUILDGRADLE'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
          }
          android {
              namespace "com.cryptex.cryptex_aer"
              compileSdk flutter.compileSdkVersion
              ndkVersion flutter.ndkVersion
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
              defaultConfig {
                  applicationId "com.cryptex.cryptex_aer"
                  minSdk flutter.minSdkVersion
                  targetSdk flutter.targetSdkVersion
                  versionCode flutter.versionCode
                  versionName flutter.versionName
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      shrinkResources true
                  }
              }
          }
          flutter { source "../.." }
          BUILDGRADLE

      - name: ðŸ”§ Fix settings.gradle
        run: |
          cd ../fresh_build
          cat > android/settings.gradle << 'SETTINGSGRADLE'
          pluginManagement {
              def flutterSdkPath = {
                  def properties = new Properties()
                  file("local.properties").withInputStream { properties.load(it) }
                  def flutterSdkPath = properties.getProperty("flutter.sdk")
                  assert flutterSdkPath != null, "flutter.sdk not set in local.properties"
                  return flutterSdkPath
              }()
              includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")
              repositories { google(); mavenCentral(); gradlePluginPortal() }
          }
          plugins {
              id "dev.flutter.flutter-plugin-loader" version "1.0.0"
              id "com.android.application" version "8.6.0" apply false
              id "org.jetbrains.kotlin.android" version "2.1.0" apply false
          }
          include ":app"
          SETTINGSGRADLE

      - name: ðŸ”§ Configure gradle.properties
        run: |
          cd ../fresh_build
          cat > android/gradle.properties << 'GRADLEPROPS'
          android.useAndroidX=true
          android.enableJetifier=true
          GRADLEPROPS

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd ../fresh_build
          flutter pub get

      - name: ðŸš€ Build Release APK
        run: |
          cd ../fresh_build
          flutter build apk --release --obfuscate --split-debug-info=./debug_symbols

      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cryptex-aer-release
          path: ../fresh_build/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
