# File: .github/workflows/z-kinetic-unified.yml
# ðŸ›¡ï¸ Z-KINETIC GHOST PROTOCOL (APK ONLY)
# Status: MOD JIMAT & PANTAS âœ…

name: Z-KINETIC Ghost Pipeline
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    name: ðŸ›¡ï¸ Secure APK Build
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¦… Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: ðŸ”¥ Nuclear Clean
        run: |
          rm -rf android/ ios/ build/ .dart_tool/ pubspec.lock
          echo "âœ… Clean complete"

      - name: ðŸ’¾ Backup Essential Files
        run: |
          mkdir -p /tmp/cryptex_backup
          cp -r lib /tmp/cryptex_backup/
          # Backup test folder jika wujud, jika tidak create dummy
          if [ -d "test" ]; then cp -r test /tmp/cryptex_backup/; else mkdir -p /tmp/cryptex_backup/test; fi
          cp pubspec.yaml /tmp/cryptex_backup/
          [ -d "assets" ] && cp -r assets /tmp/cryptex_backup/

      - name: ðŸ—ï¸ Create Fresh Project
        run: |
          cd ..
          flutter create --platforms android --org com.cryptex --project-name cryptex_aer fresh_build

      - name: ðŸ“¦ Restore User Code
        run: |
          cd ../fresh_build
          rm -rf lib/
          cp -r /tmp/cryptex_backup/lib .
          cp -r /tmp/cryptex_backup/test .
          cp /tmp/cryptex_backup/pubspec.yaml .
          [ -d "/tmp/cryptex_backup/assets" ] && cp -r /tmp/cryptex_backup/assets .

      - name: ðŸ”§ Override build.gradle
        run: |
          cd ../fresh_build
          cat > android/app/build.gradle << 'BUILDGRADLE'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
          }
          android {
              namespace "com.cryptex.cryptex_aer"
              compileSdk flutter.compileSdkVersion
              ndkVersion flutter.ndkVersion
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
              defaultConfig {
                  applicationId "com.cryptex.cryptex_aer"
                  minSdk flutter.minSdkVersion
                  targetSdk flutter.targetSdkVersion
                  versionCode flutter.versionCode
                  versionName flutter.versionName
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      shrinkResources true
                  }
              }
          }
          flutter { source "../.." }
          BUILDGRADLE

      - name: ðŸ”§ Fix settings.gradle
        run: |
          cd ../fresh_build
          cat > android/settings.gradle << 'SETTINGSGRADLE'
          pluginManagement {
              def flutterSdkPath = {
                  def properties = new Properties()
                  file("local.properties").withInputStream { properties.load(it) }
                  def flutterSdkPath = properties.getProperty("flutter.sdk")
                  assert flutterSdkPath != null, "flutter.sdk not set in local.properties"
                  return flutterSdkPath
              }()
              includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")
              repositories { google(); mavenCentral(); gradlePluginPortal() }
          }
          plugins {
              id "dev.flutter.flutter-plugin-loader" version "1.0.0"
              id "com.android.application" version "8.6.0" apply false
              id "org.jetbrains.kotlin.android" version "2.1.0" apply false
          }
          include ":app"
          SETTINGSGRADLE

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd ../fresh_build
          flutter pub get

      - name: ðŸš€ Build Release APK
        run: |
          cd ../fresh_build
          flutter build apk --release --obfuscate --split-debug-info=./debug_symbols
          mkdir -p ${{ github.workspace }}/release_output
          cp build/app/outputs/flutter-apk/app-release.apk ${{ github.workspace }}/release_output/

      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cryptex-aer-release
          path: release_output/app-release.apk
          retention-days: 30
