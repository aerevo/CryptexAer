# File: .github/workflows/z-kinetic-unified.yml
# ðŸ›¡ï¸ Z-KINETIC GHOST PROTOCOL (FIREBASE ENABLED)
# Status: PRODUCTION READY WITH FIREBASE âœ…
# Auditor: Francois (Butler)

name: Z-KINETIC Firebase Pipeline
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    name: ðŸ›¡ï¸ Secure APK Build (Firebase)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¦… Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: ðŸ”¥ Nuclear Clean
        run: |
          rm -rf android/ ios/ build/ .dart_tool/ pubspec.lock || true
          echo "âœ… Clean complete"

      - name: ðŸ’¾ Backup Essential Files
        run: |
          echo "==> Starting Backup..."
          mkdir -p ../backup_temp
          
          # Salin LIB (Wajib)
          if [ -d "lib" ]; then cp -r lib ../backup_temp/; else echo "âŒ LIB MISSING"; exit 1; fi
          
          # Salin PUBSPEC (Wajib)
          if [ -f "pubspec.yaml" ]; then cp pubspec.yaml ../backup_temp/; else echo "âŒ PUBSPEC MISSING"; exit 1; fi
          
          # Salin TEST (Jika ada)
          [ -d "test" ] && cp -r test ../backup_temp/ || echo "âš ï¸ Test skipped"
          
          # Salin ASSETS (Jika ada)
          [ -d "assets" ] && cp -r assets ../backup_temp/ || echo "âš ï¸ Assets skipped"
          
          echo "âœ… Backup secured"

      - name: ðŸ—ï¸ Create Fresh Project
        run: |
          cd ..
          flutter create --platforms android --org com.cryptex --project-name cryptex_aer fresh_build

      - name: ðŸ“¦ Restore User Code
        run: |
          echo "==> Restoring Code..."
          cd ../fresh_build
          
          # Restore Lib
          rm -rf lib/
          cp -r ../backup_temp/lib . || { echo "âŒ Failed to restore LIB"; exit 1; }
          
          # Restore Pubspec
          cp ../backup_temp/pubspec.yaml . || { echo "âŒ Failed to restore PUBSPEC"; exit 1; }
          
          # Restore Test
          if [ -d "../backup_temp/test" ]; then
             rm -rf test/
             cp -r ../backup_temp/test .
             echo "âœ… Test restored"
          fi
          
          # Restore Assets
          if [ -d "../backup_temp/assets" ]; then
             cp -r ../backup_temp/assets .
             echo "âœ… Assets restored"
          fi

      - name: ðŸ”¥ Create Firebase Config Files
        run: |
          cd ../fresh_build
          
          # 1. FIREBASE OPTIONS (AUTO-GENERATED)
          mkdir -p lib
          cat > lib/firebase_options.dart << 'FIREBASEOPTS'
          // File generated by FlutterFire CLI.
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;
          
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) {
                throw UnsupportedError('Web platform not configured');
              }
              switch (defaultTargetPlatform) {
                case TargetPlatform.android:
                  return android;
                case TargetPlatform.iOS:
                  return ios;
                default:
                  throw UnsupportedError('Platform not supported');
              }
            }
          
            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'AIzaSyDej3jrmqkUYyCs8CYepwdbrlInSBNWt_w',
              appId: '1:55621733629:android:ef51c1276ef226b0408294',
              messagingSenderId: '55621733629',
              projectId: 'z-kinetic',
              storageBucket: 'z-kinetic.firebasestorage.app',
            );
          
            static const FirebaseOptions ios = FirebaseOptions(
              apiKey: 'YOUR_IOS_API_KEY',
              appId: 'YOUR_IOS_APP_ID',
              messagingSenderId: '55621733629',
              projectId: 'z-kinetic',
              storageBucket: 'z-kinetic.firebasestorage.app',
              iosBundleId: 'com.cryptex.cryptexAer',
            );
          }
          FIREBASEOPTS
          
          # 2. GOOGLE-SERVICES.JSON
          mkdir -p android/app
          cat > android/app/google-services.json << 'GOOGLESERVICES'
          {
            "project_info": {
              "project_number": "55621733629",
              "project_id": "z-kinetic",
              "storage_bucket": "z-kinetic.firebasestorage.app"
            },
            "client": [
              {
                "client_info": {
                  "mobilesdk_app_id": "1:55621733629:android:ef51c1276ef226b0408294",
                  "android_client_info": {
                    "package_name": "com.cryptex.cryptex_aer"
                  }
                },
                "oauth_client": [],
                "api_key": [
                  {
                    "current_key": "AIzaSyDej3jrmqkUYyCs8CYepwdbrlInSBNWt_w"
                  }
                ],
                "services": {
                  "appinvite_service": {
                    "other_platform_oauth_client": []
                  }
                }
              }
            ],
            "configuration_version": "1"
          }
          GOOGLESERVICES
          
          echo "âœ… Firebase config files created"

      - name: ðŸ”§ Override build.gradle (Firebase Compatible)
        run: |
          cd ../fresh_build
          cat > android/app/build.gradle << 'BUILDGRADLE'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
              id "com.google.gms.google-services"
          }
          
          android {
              namespace "com.cryptex.cryptex_aer"
              compileSdk 34
              ndkVersion flutter.ndkVersion
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              
              kotlinOptions { 
                  jvmTarget = "17" 
              }
              
              defaultConfig {
                  applicationId "com.cryptex.cryptex_aer"
                  minSdk 23
                  targetSdk 34
                  versionCode flutterVersionCode.toInteger()
                  versionName flutterVersionName
                  multiDexEnabled true
              }
              
              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      shrinkResources true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
          }
          
          flutter { 
              source "../.." 
          }
          
          dependencies {
              implementation platform('com.google.firebase:firebase-bom:32.7.0')
              implementation 'com.google.firebase:firebase-analytics'
              implementation 'com.google.firebase:firebase-crashlytics'
              implementation 'com.google.firebase:firebase-auth'
              implementation 'com.google.firebase:firebase-firestore'
              implementation 'androidx.multidex:multidex:2.0.1'
          }
          BUILDGRADLE

      - name: ðŸ”§ Override build.gradle (Project Level)
        run: |
          cd ../fresh_build
          cat > android/build.gradle << 'PROJECTGRADLE'
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.3.2'
                  classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.24'
                  classpath 'com.google.gms:google-services:4.4.0'
                  classpath 'com.google.firebase:firebase-crashlytics-gradle:2.9.9'
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          PROJECTGRADLE

      - name: ðŸ”§ Fix settings.gradle
        run: |
          cd ../fresh_build
          cat > android/settings.gradle << 'SETTINGSGRADLE'
          pluginManagement {
              def flutterSdkPath = {
                  def properties = new Properties()
                  file("local.properties").withInputStream { properties.load(it) }
                  def flutterSdkPath = properties.getProperty("flutter.sdk")
                  assert flutterSdkPath != null, "flutter.sdk not set"
                  return flutterSdkPath
              }()
              includeBuild("$flutterSdkPath/packages/flutter_tools/gradle")
              repositories { 
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          
          plugins {
              id "dev.flutter.flutter-plugin-loader" version "1.0.0"
              id "com.android.application" version "8.3.2" apply false
              id "org.jetbrains.kotlin.android" version "1.9.24" apply false
              id "com.google.gms.google-services" version "4.4.0" apply false
          }
          
          include ":app"
          SETTINGSGRADLE

      - name: ðŸ”§ Configure gradle.properties
        run: |
          cd ../fresh_build
          cat > android/gradle.properties << 'GRADLEPROPS'
          org.gradle.jvmargs=-Xmx4096M -XX:+UseParallelGC
          org.gradle.daemon=false
          android.useAndroidX=true
          android.enableJetifier=true
          android.defaults.buildfeatures.buildconfig=true
          android.nonTransitiveRClass=false
          GRADLEPROPS

      - name: ðŸ”§ Add ProGuard Rules (Firebase Safe)
        run: |
          cd ../fresh_build
          cat > android/app/proguard-rules.pro << 'PROGUARD'
          # Firebase
          -keep class com.google.firebase.** { *; }
          -keep class com.google.android.gms.** { *; }
          -dontwarn com.google.firebase.**
          -dontwarn com.google.android.gms.**
          
          # Flutter
          -keep class io.flutter.app.** { *; }
          -keep class io.flutter.plugin.** { *; }
          -keep class io.flutter.util.** { *; }
          -keep class io.flutter.view.** { *; }
          -keep class io.flutter.** { *; }
          -keep class io.flutter.plugins.** { *; }
          PROGUARD

      - name: ðŸ“¦ Install Dependencies
        run: |
          cd ../fresh_build
          flutter pub get

      - name: ðŸš€ Build Release APK
        run: |
          cd ../fresh_build
          flutter build apk --release \
            --obfuscate \
            --split-debug-info=./debug_symbols

      - name: ðŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: z-kinetic-firebase-release
          path: ../fresh_build/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      - name: ðŸ“¤ Upload Debug Symbols
        uses: actions/upload-artifact@v4
        with:
          name: debug-symbols
          path: ../fresh_build/debug_symbols/
          retention-days: 7
