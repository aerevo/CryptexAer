name: Z-Kinetic Final Fix
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-apk:
    name: ðŸ›¡ï¸ Build APK (SDK 36)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¦… Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ðŸ”¥ Nuclear Clean
        run: |
          rm -rf android/ ios/ build/ .dart_tool/ pubspec.lock || true

      - name: ðŸ—ï¸ Create Android Project
        run: |
          flutter create --platforms android --org com.aer --project-name zkinetic .

      - name: ðŸ”¥ Create Firebase Configs
        run: |
          mkdir -p lib android/app
          
          # 1. DUMMY FIREBASE OPTIONS
          cat > lib/firebase_options.dart << 'EOF'
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, kIsWeb, TargetPlatform;
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              if (kIsWeb) throw UnsupportedError('Web not configured');
              switch (defaultTargetPlatform) {
                case TargetPlatform.android: return android;
                case TargetPlatform.iOS: return ios;
                default: throw UnsupportedError('Platform not supported');
              }
            }
            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'AIzaSyDej3jrmqkUYyCs8CYepwdbrlInSBNWt_w',
              appId: '1:55621733629:android:ef51c1276ef226b0408294',
              messagingSenderId: '55621733629',
              projectId: 'z-kinetic',
              storageBucket: 'z-kinetic.firebasestorage.app',
            );
            static const FirebaseOptions ios = FirebaseOptions(
              apiKey: 'IOS_KEY', appId: '1:55621733629:ios:dummy', messagingSenderId: '55621733629', projectId: 'z-kinetic', storageBucket: 'z-kinetic.firebasestorage.app', iosBundleId: 'com.aer.zkinetic'
            );
          }
          EOF
          
          # 2. GOOGLE SERVICES JSON
          cat > android/app/google-services.json << 'EOF'
          {
            "project_info": { "project_number": "55621733629", "project_id": "z-kinetic", "storage_bucket": "z-kinetic.firebasestorage.app" },
            "client": [{
              "client_info": { "mobilesdk_app_id": "1:55621733629:android:ef51c1276ef226b0408294", "android_client_info": { "package_name": "com.aer.zkinetic" } },
              "api_key": [{ "current_key": "AIzaSyDej3jrmqkUYyCs8CYepwdbrlInSBNWt_w" }]
            }],
            "configuration_version": "1"
          }
          EOF

      - name: ðŸ”§ Inject build.gradle (SDK 36 No Minify)
        run: |
          cat > android/app/build.gradle << 'EOF'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
              id "com.google.gms.google-services"
              id "com.google.firebase.crashlytics"
          }
          android {
              namespace = "com.aer.zkinetic"
              compileSdk = 36
              ndkVersion = flutter.ndkVersion
              compileOptions { sourceCompatibility = JavaVersion.VERSION_17; targetCompatibility = JavaVersion.VERSION_17 }
              kotlinOptions { jvmTarget = "17" }
              defaultConfig {
                  applicationId = "com.aer.zkinetic"
                  minSdk = 23
                  targetSdk = 36
                  versionCode = 1
                  versionName = "1.0"
                  multiDexEnabled = true
              }
              buildTypes {
                  release {
                      signingConfig = signingConfigs.debug
                      // ðŸ‘‡ KITA MATIKAN R8 SUPAYA TAK ADA ERROR LAMA
                      minifyEnabled = false
                      shrinkResources = false
                  }
              }
          }
          flutter { source = "../.." }
          dependencies {
              implementation(platform("com.google.firebase:firebase-bom:33.7.0"))
              implementation("com.google.firebase:firebase-analytics")
              implementation("com.google.firebase:firebase-crashlytics")
              implementation("com.google.firebase:firebase-auth")
              implementation("com.google.firebase:firebase-firestore")
              // Tambah functions dependencies
              implementation("com.google.firebase:firebase-functions")
              implementation("androidx.multidex:multidex:2.0.1")
          }
          EOF

      - name: ðŸ”§ Inject Project build.gradle
        run: |
          cat > android/build.gradle << 'EOF'
          buildscript {
              repositories { google(); mavenCentral() }
              dependencies {
                  classpath("com.android.tools.build:gradle:8.2.1")
                  classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.22")
                  classpath("com.google.gms:google-services:4.4.0")
                  classpath("com.google.firebase:firebase-crashlytics-gradle:2.9.9")
              }
          }
          allprojects { repositories { google(); mavenCentral() } }
          rootProject.buildDir = "../build"
          subprojects { project.buildDir = "${rootProject.buildDir}/${project.name}"; project.evaluationDependsOn(":app") }
          tasks.register("clean", Delete) { delete rootProject.buildDir }
          EOF

      - name: ðŸ“¦ Install Dependencies
        run: |
          flutter pub get

      - name: ðŸš€ Build APK
        run: |
          flutter build apk --release

      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: z-kinetic-final
          path: build/app/outputs/flutter-apk/app-release.apk
