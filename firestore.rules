// FILE: firestore.rules
// Z-KINETIC FIRESTORE SECURITY RULES (HARDENED)
// ðŸ”¥ UPDATED: App Check enforcement + strict validation

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // ðŸ”¥ HELPER FUNCTIONS
    // ============================================
    
    // Check if request has valid App Check token
    function hasValidAppCheck() {
      return request.auth != null && request.app != null;
    }
    
    // Check if user is admin
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    // ============================================
    // GLOBAL THREAT INTELLIGENCE COLLECTION
    // ============================================
    match /global_threat_intel/{threatId} {
      // ðŸ”¥ UPDATED: Require App Check + strict validation
      allow create: if hasValidAppCheck()
                    && request.resource.data.keys().hasAll([
                      'threat_type', 
                      'severity', 
                      'device_os', 
                      'timestamp',
                      'integrity_token', // ðŸ”¥ NEW: Must have token
                      'has_integrity_token' // ðŸ”¥ NEW: Token presence flag
                    ])
                    && request.resource.data.severity in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW']
                    && request.resource.data.threat_type is string
                    // ðŸ”¥ Ensure NO raw biometric data
                    && !request.resource.data.keys().hasAny([
                      'motion_events', 
                      'touch_events', 
                      'raw_data',
                      'biometric_data'
                    ])
                    // ðŸ”¥ Rate limiting: Max 1 report per minute per device
                    && (!exists(/databases/$(database)/documents/global_threat_intel/$(request.auth.uid)) ||
                        resource.data.timestamp < request.time - duration.value(1, 'm'));
      
      // Only admins can read threat reports
      allow read: if isAdmin();
      
      // No updates allowed (immutable threat logs)
      allow update, delete: if false;
    }
    
    // ============================================
    // THREAT STATISTICS (Aggregated Data)
    // ============================================
    match /threat_statistics/{statId} {
      // Public read for dashboard
      allow read: if request.auth != null;
      
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // ============================================
    // THREAT ANALYTICS (Dashboard Data)
    // ============================================
    match /threat_analytics/{analyticsId} {
      // Admins only
      allow read: if isAdmin();
      
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // ============================================
    // BANK ALERTS (Partner Notifications)
    // ============================================
    match /bank_alerts/{alertId} {
      // Bank partners can read their alerts
      allow read: if request.auth != null 
                  && (isAdmin() || request.auth.token.bank_partner == true);
      
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // ============================================
    // USER BASELINES (Legacy - Optional)
    // ============================================
    match /user_baselines/{deviceId} {
      // Allow users to read/write their own baseline
      allow read, write: if request.auth != null;
    }
    
    // ============================================
    // SYSTEM ERRORS (Internal Logging)
    // ============================================
    match /system_errors/{errorId} {
      // Admins only
      allow read: if isAdmin();
      
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // ============================================
    // BLACKLISTED DEVICES
    // ============================================
    match /blacklisted_devices/{deviceId} {
      // Users can check if their device is blacklisted
      allow read: if request.auth != null;
      
      // Only Cloud Functions can blacklist
      allow write: if false;
    }
    
    // ============================================
    // ðŸ”¥ NEW: USED NONCES (Replay Attack Prevention)
    // ============================================
    match /used_nonces/{nonceId} {
      // Cloud Functions only
      allow read, write: if false;
    }
    
    // ============================================
    // ðŸ”¥ NEW: SUSPICIOUS ACTIVITY LOG
    // ============================================
    match /suspicious_activity/{activityId} {
      // Admins only
      allow read: if isAdmin();
      
      // Cloud Functions only
      allow write: if false;
    }
    
    // ============================================
    // SECURITY INCIDENTS (Legacy - Deprecated)
    // ============================================
    match /security_incidents/{incidentId} {
      // Deprecated - Use global_threat_intel instead
      allow read: if isAdmin();
      allow create: if false; // Force migration to new model
    }
    
    // ============================================
    // VERIFICATION LOGS (Legacy - Deprecated)
    // ============================================
    match /verification_logs/{logId} {
      // Deprecated - No longer storing verification logs
      allow read, write: if false;
    }
    
    // ============================================
    // DEFAULT DENY ALL
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
